{% schema %}
{
  "name": "Sweater Designer",
  "settings": [
    {
      "type": "product",
      "id": "sweater_product",
      "label": "Sweater Product",
      "info": "Select the product with a single variant for all sizes"
    },
    {
      "type": "text",
      "id": "fallback_variant_id",
      "label": "Fallback Variant ID (optional)",
      "info": "If product picker doesn't work, paste the variant ID here. Find it in the product URL or API."
    },
    {
      "type": "header",
      "content": "═══ DAVID HOCKNEY (60s) ═══"
    },
    {
      "type": "image_picker",
      "id": "hockney60_thumbnail",
      "label": "Thumbnail Image"
    },
    {
      "type": "image_picker",
      "id": "hockney60_image_1",
      "label": "Gallery Image 1"
    },
    {
      "type": "image_picker",
      "id": "hockney60_image_2",
      "label": "Gallery Image 2"
    },
    {
      "type": "image_picker",
      "id": "hockney60_image_3",
      "label": "Gallery Image 3"
    },
    {
      "type": "video",
      "id": "hockney60_video",
      "label": "Video (optional)"
    },
    {
      "type": "checkbox",
      "id": "hockney60_video_as_thumbnail",
      "label": "Use video as mini thumbnail",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "hockney60_video_preview",
      "label": "Show 5-second preview loop",
      "default": true,
      "info": "When enabled, thumbnail shows first 5 seconds on loop"
    },
    {
      "type": "checkbox",
      "id": "hockney60_start_with_video",
      "label": "Start popup with video",
      "default": false,
      "info": "When enabled, clicking thumbnail opens directly to the video"
    },
    {
      "type": "text",
      "id": "hockney60_painting_name",
      "label": "Painting Name",
      "default": "A Bigger Splash (1967)"
    },
    {
      "type": "textarea",
      "id": "hockney60_bio",
      "label": "Artist Bio",
      "default": "David Hockney is a British painter, draughtsman, printmaker, and photographer. An important contributor to the Pop art movement of the 1960s, he is considered one of the most influential British artists of the 20th century."
    },
    {
      "type": "url",
      "id": "hockney60_wikipedia",
      "label": "Wikipedia Link"
    },
    {
      "type": "paragraph",
      "content": "── Palette Colors ──"
    },
    {
      "type": "color",
      "id": "hockney60_color_1",
      "label": "Color 1",
      "default": "#6b5d93"
    },
    {
      "type": "text",
      "id": "hockney60_color_1_name",
      "label": "Color 1 Name",
      "default": "Purple"
    },
    {
      "type": "color",
      "id": "hockney60_color_2",
      "label": "Color 2",
      "default": "#284354"
    },
    {
      "type": "text",
      "id": "hockney60_color_2_name",
      "label": "Color 2 Name",
      "default": "Dark Blue"
    },
    {
      "type": "color",
      "id": "hockney60_color_3",
      "label": "Color 3",
      "default": "#313539"
    },
    {
      "type": "text",
      "id": "hockney60_color_3_name",
      "label": "Color 3 Name",
      "default": "Charcoal"
    },
    {
      "type": "color",
      "id": "hockney60_color_4",
      "label": "Color 4",
      "default": "#b4a697"
    },
    {
      "type": "text",
      "id": "hockney60_color_4_name",
      "label": "Color 4 Name",
      "default": "Beige"
    },
    {
      "type": "color",
      "id": "hockney60_color_5",
      "label": "Color 5",
      "default": "#b3502e"
    },
    {
      "type": "text",
      "id": "hockney60_color_5_name",
      "label": "Color 5 Name",
      "default": "Rust Red"
    },
    {
      "type": "color",
      "id": "hockney60_color_6",
      "label": "Color 6",
      "default": "#9a6c2c"
    },
    {
      "type": "text",
      "id": "hockney60_color_6_name",
      "label": "Color 6 Name",
      "default": "Bronze"
    },
    {
      "type": "header",
      "content": "═══ FRANCIS BACON ═══"
    },
    {
      "type": "image_picker",
      "id": "bacon_thumbnail",
      "label": "Thumbnail Image"
    },
    {
      "type": "image_picker",
      "id": "bacon_image_1",
      "label": "Gallery Image 1"
    },
    {
      "type": "image_picker",
      "id": "bacon_image_2",
      "label": "Gallery Image 2"
    },
    {
      "type": "image_picker",
      "id": "bacon_image_3",
      "label": "Gallery Image 3"
    },
    {
      "type": "video",
      "id": "bacon_video",
      "label": "Video (optional)"
    },
    {
      "type": "checkbox",
      "id": "bacon_video_as_thumbnail",
      "label": "Use video as mini thumbnail",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "bacon_video_preview",
      "label": "Show 5-second preview loop",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "bacon_start_with_video",
      "label": "Start popup with video",
      "default": false
    },
    {
      "type": "text",
      "id": "bacon_painting_name",
      "label": "Painting Name",
      "default": "Three Studies of Lucian Freud (1969)"
    },
    {
      "type": "textarea",
      "id": "bacon_bio",
      "label": "Artist Bio",
      "default": "Francis Bacon was an Irish-born British figurative painter known for his raw, unsettling imagery. His bold, grotesque depictions of the human form made him one of the most acclaimed painters of the 20th century."
    },
    {
      "type": "url",
      "id": "bacon_wikipedia",
      "label": "Wikipedia Link"
    },
    {
      "type": "paragraph",
      "content": "── Palette Colors ──"
    },
    {
      "type": "color",
      "id": "bacon_color_1",
      "label": "Color 1",
      "default": "#d35968"
    },
    {
      "type": "text",
      "id": "bacon_color_1_name",
      "label": "Color 1 Name",
      "default": "Rose"
    },
    {
      "type": "color",
      "id": "bacon_color_2",
      "label": "Color 2",
      "default": "#ff83a1"
    },
    {
      "type": "text",
      "id": "bacon_color_2_name",
      "label": "Color 2 Name",
      "default": "Pink"
    },
    {
      "type": "color",
      "id": "bacon_color_3",
      "label": "Color 3",
      "default": "#8c6f64"
    },
    {
      "type": "text",
      "id": "bacon_color_3_name",
      "label": "Color 3 Name",
      "default": "Brown"
    },
    {
      "type": "color",
      "id": "bacon_color_4",
      "label": "Color 4",
      "default": "#1a352c"
    },
    {
      "type": "text",
      "id": "bacon_color_4_name",
      "label": "Color 4 Name",
      "default": "Forest"
    },
    {
      "type": "color",
      "id": "bacon_color_5",
      "label": "Color 5",
      "default": "#d8d5d2"
    },
    {
      "type": "text",
      "id": "bacon_color_5_name",
      "label": "Color 5 Name",
      "default": "Cream"
    },
    {
      "type": "color",
      "id": "bacon_color_6",
      "label": "Color 6",
      "default": "#000000"
    },
    {
      "type": "text",
      "id": "bacon_color_6_name",
      "label": "Color 6 Name",
      "default": "Black"
    },
    {
      "type": "header",
      "content": "═══ KEN PRICE ═══"
    },
    {
      "type": "image_picker",
      "id": "price_thumbnail",
      "label": "Thumbnail Image"
    },
    {
      "type": "image_picker",
      "id": "price_image_1",
      "label": "Gallery Image 1"
    },
    {
      "type": "image_picker",
      "id": "price_image_2",
      "label": "Gallery Image 2"
    },
    {
      "type": "image_picker",
      "id": "price_image_3",
      "label": "Gallery Image 3"
    },
    {
      "type": "video",
      "id": "price_video",
      "label": "Video (optional)"
    },
    {
      "type": "checkbox",
      "id": "price_video_as_thumbnail",
      "label": "Use video as mini thumbnail",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "price_video_preview",
      "label": "Show 5-second preview loop",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "price_start_with_video",
      "label": "Start popup with video",
      "default": false
    },
    {
      "type": "text",
      "id": "price_painting_name",
      "label": "Artwork Name",
      "default": "Untitled Cup (1972)"
    },
    {
      "type": "textarea",
      "id": "price_bio",
      "label": "Artist Bio",
      "default": "Ken Price was an American artist known for his ceramic sculptures. His works are notable for their unique shapes, vibrant colors, and surfaces that blur the line between sculpture and painting."
    },
    {
      "type": "url",
      "id": "price_wikipedia",
      "label": "Wikipedia Link"
    },
    {
      "type": "paragraph",
      "content": "── Palette Colors ──"
    },
    {
      "type": "color",
      "id": "price_color_1",
      "label": "Color 1",
      "default": "#59261f"
    },
    {
      "type": "text",
      "id": "price_color_1_name",
      "label": "Color 1 Name",
      "default": "Brown"
    },
    {
      "type": "color",
      "id": "price_color_2",
      "label": "Color 2",
      "default": "#000000"
    },
    {
      "type": "text",
      "id": "price_color_2_name",
      "label": "Color 2 Name",
      "default": "Black"
    },
    {
      "type": "color",
      "id": "price_color_3",
      "label": "Color 3",
      "default": "#9cbdb4"
    },
    {
      "type": "text",
      "id": "price_color_3_name",
      "label": "Color 3 Name",
      "default": "Teal"
    },
    {
      "type": "color",
      "id": "price_color_4",
      "label": "Color 4",
      "default": "#be4b2e"
    },
    {
      "type": "text",
      "id": "price_color_4_name",
      "label": "Color 4 Name",
      "default": "Rust"
    },
    {
      "type": "color",
      "id": "price_color_5",
      "label": "Color 5",
      "default": "#7d90b2"
    },
    {
      "type": "text",
      "id": "price_color_5_name",
      "label": "Color 5 Name",
      "default": "Blue"
    },
    {
      "type": "color",
      "id": "price_color_6",
      "label": "Color 6",
      "default": "#843345"
    },
    {
      "type": "text",
      "id": "price_color_6_name",
      "label": "Color 6 Name",
      "default": "Burgundy"
    },
    {
      "type": "header",
      "content": "═══ DAVID HOCKNEY (2013) ═══"
    },
    {
      "type": "image_picker",
      "id": "hockney13_thumbnail",
      "label": "Thumbnail Image"
    },
    {
      "type": "image_picker",
      "id": "hockney13_image_1",
      "label": "Gallery Image 1"
    },
    {
      "type": "image_picker",
      "id": "hockney13_image_2",
      "label": "Gallery Image 2"
    },
    {
      "type": "image_picker",
      "id": "hockney13_image_3",
      "label": "Gallery Image 3"
    },
    {
      "type": "video",
      "id": "hockney13_video",
      "label": "Video (optional)"
    },
    {
      "type": "checkbox",
      "id": "hockney13_video_as_thumbnail",
      "label": "Use video as mini thumbnail",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "hockney13_video_preview",
      "label": "Show 5-second preview loop",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "hockney13_start_with_video",
      "label": "Start popup with video",
      "default": false
    },
    {
      "type": "text",
      "id": "hockney13_painting_name",
      "label": "Painting Name",
      "default": "The Arrival of Spring in Woldgate (2013)"
    },
    {
      "type": "textarea",
      "id": "hockney13_bio",
      "label": "Artist Bio",
      "default": "In his later career, David Hockney embraced digital tools, creating vibrant landscapes on his iPad. His \"Arrival of Spring\" series captures the Yorkshire countryside in bold, saturated colors."
    },
    {
      "type": "url",
      "id": "hockney13_wikipedia",
      "label": "Wikipedia Link"
    },
    {
      "type": "paragraph",
      "content": "── Palette Colors ──"
    },
    {
      "type": "color",
      "id": "hockney13_color_1",
      "label": "Color 1",
      "default": "#890222"
    },
    {
      "type": "text",
      "id": "hockney13_color_1_name",
      "label": "Color 1 Name",
      "default": "Crimson"
    },
    {
      "type": "color",
      "id": "hockney13_color_2",
      "label": "Color 2",
      "default": "#a40556"
    },
    {
      "type": "text",
      "id": "hockney13_color_2_name",
      "label": "Color 2 Name",
      "default": "Magenta"
    },
    {
      "type": "color",
      "id": "hockney13_color_3",
      "label": "Color 3",
      "default": "#7baa5e"
    },
    {
      "type": "text",
      "id": "hockney13_color_3_name",
      "label": "Color 3 Name",
      "default": "Olive"
    },
    {
      "type": "color",
      "id": "hockney13_color_4",
      "label": "Color 4",
      "default": "#036433"
    },
    {
      "type": "text",
      "id": "hockney13_color_4_name",
      "label": "Color 4 Name",
      "default": "Forest"
    },
    {
      "type": "color",
      "id": "hockney13_color_5",
      "label": "Color 5",
      "default": "#14352a"
    },
    {
      "type": "text",
      "id": "hockney13_color_5_name",
      "label": "Color 5 Name",
      "default": "Dark Green"
    },
    {
      "type": "color",
      "id": "hockney13_color_6",
      "label": "Color 6",
      "default": "#f2d075"
    },
    {
      "type": "text",
      "id": "hockney13_color_6_name",
      "label": "Color 6 Name",
      "default": "Yellow"
    },
    {
      "type": "header",
      "content": "═══ NATISA JONES ═══"
    },
    {
      "type": "image_picker",
      "id": "jones_thumbnail",
      "label": "Thumbnail Image"
    },
    {
      "type": "image_picker",
      "id": "jones_image_1",
      "label": "Gallery Image 1"
    },
    {
      "type": "image_picker",
      "id": "jones_image_2",
      "label": "Gallery Image 2"
    },
    {
      "type": "image_picker",
      "id": "jones_image_3",
      "label": "Gallery Image 3"
    },
    {
      "type": "video",
      "id": "jones_video",
      "label": "Video (optional)"
    },
    {
      "type": "checkbox",
      "id": "jones_video_as_thumbnail",
      "label": "Use video as mini thumbnail",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "jones_video_preview",
      "label": "Show 5-second preview loop",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "jones_start_with_video",
      "label": "Start popup with video",
      "default": false
    },
    {
      "type": "text",
      "id": "jones_painting_name",
      "label": "Painting Name",
      "default": "Growth Spurt (2021)"
    },
    {
      "type": "textarea",
      "id": "jones_bio",
      "label": "Artist Bio",
      "default": "Natisa Jones is a Bali-based artist whose expressive paintings explore themes of growth, identity, and the human condition through bold colors and dynamic brushwork."
    },
    {
      "type": "url",
      "id": "jones_wikipedia",
      "label": "Wikipedia/Website Link"
    },
    {
      "type": "paragraph",
      "content": "── Palette Colors ──"
    },
    {
      "type": "color",
      "id": "jones_color_1",
      "label": "Color 1",
      "default": "#6b191f"
    },
    {
      "type": "text",
      "id": "jones_color_1_name",
      "label": "Color 1 Name",
      "default": "Deep Red"
    },
    {
      "type": "color",
      "id": "jones_color_2",
      "label": "Color 2",
      "default": "#c32728"
    },
    {
      "type": "text",
      "id": "jones_color_2_name",
      "label": "Color 2 Name",
      "default": "Bright Red"
    },
    {
      "type": "color",
      "id": "jones_color_3",
      "label": "Color 3",
      "default": "#930918"
    },
    {
      "type": "text",
      "id": "jones_color_3_name",
      "label": "Color 3 Name",
      "default": "Crimson"
    },
    {
      "type": "color",
      "id": "jones_color_4",
      "label": "Color 4",
      "default": "#f1dbd0"
    },
    {
      "type": "text",
      "id": "jones_color_4_name",
      "label": "Color 4 Name",
      "default": "Peach"
    },
    {
      "type": "color",
      "id": "jones_color_5",
      "label": "Color 5",
      "default": "#000000"
    },
    {
      "type": "text",
      "id": "jones_color_5_name",
      "label": "Color 5 Name",
      "default": "Black"
    },
    {
      "type": "color",
      "id": "jones_color_6",
      "label": "Color 6",
      "default": "#f3f2de"
    },
    {
      "type": "text",
      "id": "jones_color_6_name",
      "label": "Color 6 Name",
      "default": "Cream"
    }
  ],
  "presets": [{ "name": "Sweater Designer" }]
}
{% endschema %}

<div
  class='sweater-designer'
  style='margin:120px auto; display:flex; font-family:Jost, sans-serif; width:100%; position:relative;'
>
  <!-- SWEATER AREA (now on left) -->
  <div id='sweater-area' class='sweater-area'>
    <!-- Combined sweater + swatches container with border -->
    <div
      id='sweater-and-swatches-container'
      style='box-sizing: border-box; max-width: 860px; margin: 0 auto; position: relative;'
    >
      <button id='tutorial-btn' title='Show tutorial'>?</button>

      <div
        id='sweater-svg-wrapper'
        style='width:100%; margin:0 auto; overflow:visible; transition: transform 0.3s ease;'
      >
        <svg
          id='sweater-svg'
          xmlns='http://www.w3.org/2000/svg'
          viewBox='0 0 1920 1080'
          style='width:100%; height:auto; display:block; max-height:900px;'
        >
          {% include 'sweater-svg-content' %}
        </svg>
      </div>

      <div class='sweater-designer_bottom'>
        <!-- SWEATER SWATCHES -->
        <div style='position:relative; display:flex; justify-content:center; margin-top:20px;'>
          <div
            id='swatch-container'
            style='display:flex; flex-direction:row; justify-content:center; gap:12px; padding:0; background:none; border:none;'
          ></div>

          <!-- SWEATER TOOLTIP -->
          <div
            id='color-picker-tooltip'
            style='display:none; position:absolute; bottom:calc(100% + 10px); left:50%; transform:translateX(-50%); background:#000; color:#fff; padding:8px 12px; border-radius:0; font-size:10px; font-weight:600; letter-spacing:0.3px; text-transform:uppercase; white-space:nowrap; z-index:1000; pointer-events:auto; font-family:Arial, sans-serif;'
          >
            Select color, click a stripe
            <div
              style='position:absolute; top:100%; left:50%; transform:translateX(-50%); width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:6px solid #000;'
            ></div>
          </div>
        </div>

        <!-- SWEATER TITLE AND NAVIGATION -->
        <div
          id='sweater-navigation'
          class='sweater-designer_nav'
        >
          <button
            id='prev-designer'
            style='background:transparent !important; border:none !important; cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center; opacity: 0.3; outline:none !important; box-shadow:none !important; -webkit-appearance:none !important; -moz-appearance:none !important; appearance:none !important;'
          >
            <svg width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='#666' stroke-width='2'>
              <polyline points="15,18 9,12 15,6"></polyline>
            </svg>
          </button>
          <h3 id='designer-name' style='margin:0; font-size:20px; color:currentColor;'>David Hockney (60s)</h3>
          <button
            id='next-designer'
            style='background:transparent !important; border:none !important; cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center; outline:none !important; box-shadow:none !important; -webkit-appearance:none !important; -moz-appearance:none !important; appearance:none !important;'
          >
            <svg width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='#666' stroke-width='2'>
              <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
          </button>
        </div>
        <!-- SWEATER CONTROLS -->
        <div class='sweater-designer_controls'>
          <button
            id='random-btn'
            class='sweater-designer_control-buttons'
            type='button'
            style='width:auto !important; color:black; border:none; background:none;'
          >
            <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='currentColor' viewBox='0 -960 960 960'>
              <path d="M560-160v-80h104L537-367l57-57 126 126v-102h80v240zm-344 0-56-56 504-504H560v-80h240v240h-80v-104zm151-377L160-744l56-56 207 207z"/>
            </svg>
            <span>random</span>
          </button>
          <button
            id='default-btn'
            class='sweater-designer_control-buttons'
            type='button'
            style='width:auto !important; border-radius:0; background:none; color:black; border:none;'
          >
            <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='currentColor' viewBox='0 -960 960 960'>
              <path d="M480-80q-75 0-140.5-28.5t-114-77-77-114T120-440h80q0 117 81.5 198.5T480-160t198.5-81.5T760-440t-81.5-198.5T480-720h-6l62 62-56 58-160-160 160-160 56 58-62 62h6q75 0 140.5 28.5t114 77 77 114T840-440t-28.5 140.5-77 114-114 77T480-80"/>
            </svg>
            <span>reset</span>
          </button>
          <button
            id='info-btn'
            class='sweater-designer_control-buttons'
            aria-label='details'
            style='width:auto !important; border-radius:0; background:none; color:black; border:none;'
          >
            <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='currentColor' viewBox='0 -960 960 960'>
              <path d="M440-280h80v-240h-80zm40-320q17 0 28.5-11.5T520-640t-11.5-28.5T480-680t-28.5 11.5T440-640t11.5 28.5T480-600m0 520q-83 0-156-31.5T197-197t-85.5-127T80-480t31.5-156T197-763t127-85.5T480-880t156 31.5T763-763t85.5 127T880-480t-31.5 156T763-197t-127 85.5T480-80m0-80q134 0 227-93t93-227-93-227-227-93-227 93-93 227 93 227 227 93m0-320"/>
            </svg>
            <span>garment</span>
          </button>
        </div>
      </div>
      <!-- END SWEATHER-DESIGNER -->
    </div>

    <div
      id='name-label-preview'
      style='display:none; text-align:center; font-size:26px; font-weight:700; margin-top:10px;'
    ></div>
  </div>

  <!-- CONTROLS PANEL -->
  <div
    id='controls-panel'
    class='controls-panel'
  >
    <!-- PRICE -->
    <div
      id='controls-panel_price'
      class='controls-panel_price'
    >
      <p style='font-size:22px; padding:0; margin:0; margin-bottom:0.5rem; color:#000; text-align:center; width:100%; max-width:100%; line-height:1.4;'>
        <strong>€320</strong>
      </p>
      <div class='mobile-controls-grid'>
        <select
          id='sweater-size'
          style="padding:8px 10px; border-radius:8px; border:2px solid #ccc; font-size:18px; width:100%; text-align:center; cursor:pointer; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, sans-serif;"
        >
          <option value='XXS'>XXS</option>
          <option value='XS'>XS</option>
          <option value='S'>S</option>
          <option value='M' selected>M</option>
          <option value='L'>L</option>
          <option value='XL'>XL</option>
        </select>
        <button
          id='add-to-cart'
          style='padding:16px 16px; border-radius:0; background:black; color:#fff; border:none; cursor:pointer; width:100%; font-weight:700; font-size:12px; letter-spacing:0.5px; text-transform:uppercase;'
        >
          ADD TO BAG
        </button>
        <input id='custom-name' type='text' placeholder='name?' style='display: none;'>
      </div>
    </div>

    <!-- DESIGNER IMAGE -->
    <div
      id='mini-designer-image'
      class='mini-designer-image'
    >
      <img
        id='mini-designer-img'
        src='https://cdn.shopify.com/s/files/1/0965/8233/6843/files/Screenshot_2025-09-20_at_14.20.52_430x.png?v=1758370873#'
        style='width:100%; height:100%; object-fit:cover;'
      >
      <video
        id='mini-designer-video'
        muted
        playsinline
        style='display:none; width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0;'
      ></video>
      <span>Artist Palettes</span>
    </div>
  </div>
</div>

<!-- Animated cursor for tutorial -->
<div class='tutorial-cursor' id='tutorial-cursor'>
  <svg width='24' height='24' viewBox='0 0 24 24' fill='none'>
    <path d="M3 3L10.07 19.97L12.58 12.58L19.97 10.07L3 3Z" fill="white" stroke="black" stroke-width="1.5"/>
  </svg>
</div>

<!-- Hidden input to store product variant ID from Shopify -->
<input type='hidden' id='product-variant-id' value='53362523865419'>

<!-- Expanded Designer Image Overlay with Carousel -->
<div
  id='expanded-designer-overlay'
  style='display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9998; cursor:pointer; overflow-y:auto;'
>
  <button
    id='close-overlay-btn'
    style='position:fixed; top:20px; right:20px; background:transparent; border:none; color:white; font-size:32px; cursor:pointer; z-index:10000; width:44px; height:44px; display:flex; align-items:center; justify-content:center;'
  >
    ×
  </button>

  <div
    id='expanded-content'
  >
    <!-- Carousel Container -->
    <div id='carousel-container'>
      <!-- Carousel Images/Video -->
      <div id='carousel-track'>
        <div class='carousel-slide active' data-index='0'>
          <img id='carousel-img-0' src=''>
        </div>
        <div class='carousel-slide' data-index='1' style='display:none;'>
          <img id='carousel-img-1' src=''>
        </div>
        <div class='carousel-slide' data-index='2' style='display:none;'>
          <img id='carousel-img-2' src=''>
        </div>
        <div class='carousel-slide carousel-video-slide' data-index='3' style='display:none;'>
          <video
            id='carousel-video'
            controls
            playsinline
            webkit-playsinline
            style='width:100%; height:auto; object-fit:contain; background:#000;'
          ></video>
        </div>
      </div>

      <!-- Carousel Navigation Arrows -->
      <button
        id='carousel-prev'
        style='position:absolute; left:10px; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.9); border:none; width:44px; height:44px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; box-shadow:0 2px 8px rgba(0,0,0,0.3); z-index:10;'
      >
        <svg width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='#000' stroke-width='2.5'>
          <polyline points="15,18 9,12 15,6"></polyline>
        </svg>
      </button>
      <button
        id='carousel-next'
        style='position:absolute; right:10px; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.9); border:none; width:44px; height:44px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; box-shadow:0 2px 8px rgba(0,0,0,0.3); z-index:10;'
      >
        <svg width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='#000' stroke-width='2.5'>
          <polyline points="9,18 15,12 9,6"></polyline>
        </svg>
      </button>

      <!-- Sound Toggle Button (only visible on video slide) -->
      <button
        id='carousel-sound-toggle'
        style='display:none; position:absolute; right:10px; top:10px; background:rgba(0,0,0,0.7); border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; align-items:center; justify-content:center; z-index:10; transition: all 0.2s ease;'
      >
        <svg id='sound-on-icon' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='#fff' stroke-width='2'>
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
          <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
        <svg
          id='sound-off-icon'
          width='20'
          height='20'
          viewBox='0 0 24 24'
          fill='none'
          stroke='#fff'
          stroke-width='2'
          style='display:none;'
        >
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
          <line x1="23" y1="9" x2="17" y2="15"></line>
          <line x1="17" y1="9" x2="23" y2="15"></line>
        </svg>
      </button>

      <!-- Carousel Dots - will be populated dynamically -->
      <div
        id='carousel-dots'
        style='position:absolute; bottom:15px; left:50%; transform:translateX(-50%); display:flex; gap:8px; z-index:10;'
      ></div>
    </div>

    <!-- Artist Info Section -->
    <div id='artist-info' style='background:#fff; padding:24px; margin-top:0;'>
      <h2 id='expanded-designer-name' style='margin:0 0 8px 0; font-size:24px; font-weight:700; color:#000;'></h2>
      <p id='expanded-painting-name' style='margin:0 0 16px 0; font-size:16px; color:#666; font-style:italic;'></p>
      <p id='expanded-bio' style='margin:0 0 20px 0; font-size:14px; line-height:1.6; color:#333;'></p>
      <a
        id='expanded-wikipedia'
        href='#'
        target='_blank'
        rel='noopener noreferrer'
        style='display:inline-flex; align-items:center; gap:8px; color:#0066cc; text-decoration:none; font-size:14px; font-weight:500;'
      >
        <svg width='16' height='16' viewBox='0 0 24 24' fill='currentColor'>
          <path d="M12.09 13.119c-.936 1.932-2.217 4.548-2.853 5.728-.616 1.074-1.127.931-1.532.029-1.406-3.321-4.293-9.144-5.651-12.409-.251-.601-.441-.987-.619-1.139-.181-.15-.554-.24-1.122-.271C.103 5.033 0 4.982 0 4.898v-.455l.052-.045c.924-.005 5.401 0 5.401 0l.051.045v.434c0 .119-.075.176-.225.176l-.564.031c-.485.029-.727.164-.727.436 0 .135.053.33.166.601 1.082 2.646 4.818 10.521 4.818 10.521l.136.046 2.411-4.81-.482-1.067-1.658-3.264s-.318-.654-.428-.872c-.728-1.443-.712-1.518-1.447-1.617-.207-.023-.313-.05-.313-.149v-.468l.06-.045h4.292l.113.037v.451c0 .105-.076.15-.227.15l-.308.047c-.792.061-.661.381-.136 1.422l1.582 3.252 1.758-3.504c.293-.64.233-.801.111-.947-.07-.084-.305-.22-.812-.24l-.201-.021c-.052 0-.098-.015-.145-.051-.045-.031-.067-.076-.067-.129v-.427l.061-.045c1.247-.008 4.043 0 4.043 0l.059.045v.436c0 .121-.059.178-.193.178-.646.03-.782.095-1.023.439-.12.186-.375.589-.646 1.039l-2.301 4.273-.065.135 2.792 5.712.17.048 4.396-10.438c.154-.422.129-.722-.064-.895-.197-.172-.346-.273-.857-.295l-.42-.016c-.061 0-.105-.014-.152-.045-.043-.029-.072-.075-.072-.119v-.436l.059-.045h4.961l.041.045v.437c0 .119-.074.18-.209.18-.648.03-1.127.18-1.443.421-.314.255-.557.616-.736 1.067 0 0-4.043 9.258-5.426 12.339-.525 1.007-1.053.917-1.503-.031-.571-1.171-1.773-3.786-2.646-5.71l.053-.036z"/>
        </svg>
        Learn more on Wikipedia
      </a>
    </div>
  </div>
</div>

<!-- Info tooltip -->
<div
  id='info-tooltip'
  style='display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); max-width:520px; padding:16px; background:#000; color:#fff; border:2px solid #fff; z-index:9999; pointer-events:none; text-align:left;'
>
  <p style='margin:0; font-weight:700;'>David Hockney (60s)</p>
  <img
    src='https://cdn.shopify.com/s/files/1/0965/8233/6843/files/hockney60_430x.jpg?v=1762161908'
    style='width:75%; display:block; margin:10px auto;'
  >
  <p style='margin:0;'>
    - Oversized, medium weight sweater, with round neck. Ribbed hem and cuffs. Size down if you want it fitted.<br>
    - Unisex, but for sizes, follow men's sizing. More info here. <br>
    - Due to technical limitations there is a maximum of 4 colors in the body, 5 per sleeve, 6 for the hems and cuffs.
    <br>
    - Third stripe on the right arm is reversed.<br>
    - 100% superfine merino wool. <br>
    - Colors are carefully selected to work in any combination. Don't be boring.<br>
    Made in the Netherlands.
  </p>
</div>

<!-- Confirmation panel (in-page) -->
<div
  id='sweater-confirm'
  style='display:none; position:fixed; right:18px; bottom:18px; z-index:3000; background:#111; color:#fff; padding:14px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.4);'
>
  <div id='sweater-confirm-text' style='margin-bottom:8px; font-weight:600;'>Added to cart</div>
  <div style='display:flex; gap:8px; justify-content:flex-end;'>
    <button
      id='sweater-confirm-go'
      style='padding:8px 10px; border-radius:6px; border:none; background:#fff; color:#111; cursor:pointer;'
    >
      Go to cart
    </button>
    <button
      id='sweater-confirm-keep'
      style='padding:8px 10px; border-radius:6px; border:1px solid #ccc; background:transparent; color:#fff; cursor:pointer;'
    >
      Keep customizing
    </button>
  </div>
</div>

<!-- Color constraints warning -->
<div
  id='color-warning'
  style='display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#ff4444; color:white; padding:12px 16px; border-radius:8px; z-index:1000; font-size:14px; font-weight:600;'
>
  <span id='color-warning-text'></span>
  <button
    onclick="document.getElementById('color-warning').style.display='none'"
    style='background:none; border:none; color:white; margin-left:8px; cursor:pointer; font-weight:bold;'
  >
    ×
  </button>
</div>

<!-- Hidden data from Shopify settings -->
<script type='application/json' id='designer-gallery-data'>
  {
    "0": {
      "thumbnail": {% if section.settings.hockney60_thumbnail %}"{{ section.settings.hockney60_thumbnail | image_url: width: 400 }}"{% else %}""{% endif %},
      "images": [
        {% if section.settings.hockney60_image_1 %}"{{ section.settings.hockney60_image_1 | image_url: width: 1200 }}"{% else %}""{% endif %},
        {% if section.settings.hockney60_image_2 %}"{{ section.settings.hockney60_image_2 | image_url: width: 1200 }}"{% else %}""{% endif %},
        {% if section.settings.hockney60_image_3 %}"{{ section.settings.hockney60_image_3 | image_url: width: 1200 }}"{% else %}""{% endif %}
      ],
      "video": {% if section.settings.hockney60_video %}"{{ section.settings.hockney60_video.sources[0].url }}"{% else %}""{% endif %},
      "videoAsThumbnail": {{ section.settings.hockney60_video_as_thumbnail | json }},
      "videoPreview": {{ section.settings.hockney60_video_preview | json }},
      "startWithVideo": {{ section.settings.hockney60_start_with_video | json }},
      "paintingName": {{ section.settings.hockney60_painting_name | json }},
      "bio": {{ section.settings.hockney60_bio | json }},
      "wikipedia": {{ section.settings.hockney60_wikipedia | json }},
      "colors": [
        { "name": {{ section.settings.hockney60_color_1_name | json }}, "hex": "{{ section.settings.hockney60_color_1 }}" },
        { "name": {{ section.settings.hockney60_color_2_name | json }}, "hex": "{{ section.settings.hockney60_color_2 }}" },
        { "name": {{ section.settings.hockney60_color_3_name | json }}, "hex": "{{ section.settings.hockney60_color_3 }}" },
        { "name": {{ section.settings.hockney60_color_4_name | json }}, "hex": "{{ section.settings.hockney60_color_4 }}" },
        { "name": {{ section.settings.hockney60_color_5_name | json }}, "hex": "{{ section.settings.hockney60_color_5 }}" },
        { "name": {{ section.settings.hockney60_color_6_name | json }}, "hex": "{{ section.settings.hockney60_color_6 }}" }
      ]
    },
    "1": {
      "thumbnail": {% if section.settings.bacon_thumbnail %}"{{ section.settings.bacon_thumbnail | image_url: width: 400 }}"{% else %}""{% endif %},
      "images": [
        {% if section.settings.bacon_image_1 %}"{{ section.settings.bacon_image_1 | image_url: width: 1200 }}"{% else %}""{% endif %},
        {% if section.settings.bacon_image_2 %}"{{ section.settings.bacon_image_2 | image_url: width: 1200 }}"{% else %}""{% endif %},
        {% if section.settings.bacon_image_3 %}"{{ section.settings.bacon_image_3 | image_url: width: 1200 }}"{% else %}""{% endif %}
      ],
      "video": {% if section.settings.bacon_video %}"{{ section.settings.bacon_video.sources[0].url }}"{% else %}""{% endif %},
      "videoAsThumbnail": {{ section.settings.bacon_video_as_thumbnail | json }},
      "videoPreview": {{ section.settings.bacon_video_preview | json }},
      "startWithVideo": {{ section.settings.bacon_start_with_video | json }},
      "paintingName": {{ section.settings.bacon_painting_name | json }},
      "bio": {{ section.settings.bacon_bio | json }},
      "wikipedia": {{ section.settings.bacon_wikipedia | json }},
      "colors": [
        { "name": {{ section.settings.bacon_color_1_name | json }}, "hex": "{{ section.settings.bacon_color_1 }}" },
        { "name": {{ section.settings.bacon_color_2_name | json }}, "hex": "{{ section.settings.bacon_color_2 }}" },
        { "name": {{ section.settings.bacon_color_3_name | json }}, "hex": "{{ section.settings.bacon_color_3 }}" },
        { "name": {{ section.settings.bacon_color_4_name | json }}, "hex": "{{ section.settings.bacon_color_4 }}" },
        { "name": {{ section.settings.bacon_color_5_name | json }}, "hex": "{{ section.settings.bacon_color_5 }}" },
        { "name": {{ section.settings.bacon_color_6_name | json }}, "hex": "{{ section.settings.bacon_color_6 }}" }
      ]
    },
    "2": {
      "thumbnail": {% if section.settings.price_thumbnail %}"{{ section.settings.price_thumbnail | image_url: width: 400 }}"{% else %}""{% endif %},
      "images": [
        {% if section.settings.price_image_1 %}"{{ section.settings.price_image_1 | image_url: width: 1200 }}"{% else %}""{% endif %},
        {% if section.settings.price_image_2 %}"{{ section.settings.price_image_2 | image_url: width: 1200 }}"{% else %}""{% endif %},
        {% if section.settings.price_image_3 %}"{{ section.settings.price_image_3 | image_url: width: 1200 }}"{% else %}""{% endif %}
      ],
      "video": {% if section.settings.price_video %}"{{ section.settings.price_video.sources[0].url }}"{% else %}""{% endif %},
      "videoAsThumbnail": {{ section.settings.price_video_as_thumbnail | json }},
      "videoPreview": {{ section.settings.price_video_preview | json }},
      "startWithVideo": {{ section.settings.price_start_with_video | json }},
      "paintingName": {{ section.settings.price_painting_name | json }},
      "bio": {{ section.settings.price_bio | json }},
      "wikipedia": {{ section.settings.price_wikipedia | json }},
      "colors": [
        { "name": {{ section.settings.price_color_1_name | json }}, "hex": "{{ section.settings.price_color_1 }}" },
        { "name": {{ section.settings.price_color_2_name | json }}, "hex": "{{ section.settings.price_color_2 }}" },
        { "name": {{ section.settings.price_color_3_name | json }}, "hex": "{{ section.settings.price_color_3 }}" },
        { "name": {{ section.settings.price_color_4_name | json }}, "hex": "{{ section.settings.price_color_4 }}" },
        { "name": {{ section.settings.price_color_5_name | json }}, "hex": "{{ section.settings.price_color_5 }}" },
        { "name": {{ section.settings.price_color_6_name | json }}, "hex": "{{ section.settings.price_color_6 }}" }
      ]
    },
    "3": {
      "thumbnail": {% if section.settings.hockney13_thumbnail %}"{{ section.settings.hockney13_thumbnail | image_url: width: 400 }}"{% else %}""{% endif %},
      "images": [
        {% if section.settings.hockney13_image_1 %}"{{ section.settings.hockney13_image_1 | image_url: width: 1200 }}"{% else %}""{% endif %},
        {% if section.settings.hockney13_image_2 %}"{{ section.settings.hockney13_image_2 | image_url: width: 1200 }}"{% else %}""{% endif %},
        {% if section.settings.hockney13_image_3 %}"{{ section.settings.hockney13_image_3 | image_url: width: 1200 }}"{% else %}""{% endif %}
      ],
      "video": {% if section.settings.hockney13_video %}"{{ section.settings.hockney13_video.sources[0].url }}"{% else %}""{% endif %},
      "videoAsThumbnail": {{ section.settings.hockney13_video_as_thumbnail | json }},
      "videoPreview": {{ section.settings.hockney13_video_preview | json }},
      "startWithVideo": {{ section.settings.hockney13_start_with_video | json }},
      "paintingName": {{ section.settings.hockney13_painting_name | json }},
      "bio": {{ section.settings.hockney13_bio | json }},
      "wikipedia": {{ section.settings.hockney13_wikipedia | json }},
      "colors": [
        { "name": {{ section.settings.hockney13_color_1_name | json }}, "hex": "{{ section.settings.hockney13_color_1 }}" },
        { "name": {{ section.settings.hockney13_color_2_name | json }}, "hex": "{{ section.settings.hockney13_color_2 }}" },
        { "name": {{ section.settings.hockney13_color_3_name | json }}, "hex": "{{ section.settings.hockney13_color_3 }}" },
        { "name": {{ section.settings.hockney13_color_4_name | json }}, "hex": "{{ section.settings.hockney13_color_4 }}" },
        { "name": {{ section.settings.hockney13_color_5_name | json }}, "hex": "{{ section.settings.hockney13_color_5 }}" },
        { "name": {{ section.settings.hockney13_color_6_name | json }}, "hex": "{{ section.settings.hockney13_color_6 }}" }
      ]
    },
    "4": {
      "thumbnail": {% if section.settings.jones_thumbnail %}"{{ section.settings.jones_thumbnail | image_url: width: 400 }}"{% else %}""{% endif %},
      "images": [
        {% if section.settings.jones_image_1 %}"{{ section.settings.jones_image_1 | image_url: width: 1200 }}"{% else %}""{% endif %},
        {% if section.settings.jones_image_2 %}"{{ section.settings.jones_image_2 | image_url: width: 1200 }}"{% else %}""{% endif %},
        {% if section.settings.jones_image_3 %}"{{ section.settings.jones_image_3 | image_url: width: 1200 }}"{% else %}""{% endif %}
      ],
      "video": {% if section.settings.jones_video %}"{{ section.settings.jones_video.sources[0].url }}"{% else %}""{% endif %},
      "videoAsThumbnail": {{ section.settings.jones_video_as_thumbnail | json }},
      "videoPreview": {{ section.settings.jones_video_preview | json }},
      "startWithVideo": {{ section.settings.jones_start_with_video | json }},
      "paintingName": {{ section.settings.jones_painting_name | json }},
      "bio": {{ section.settings.jones_bio | json }},
      "wikipedia": {{ section.settings.jones_wikipedia | json }},
      "colors": [
        { "name": {{ section.settings.jones_color_1_name | json }}, "hex": "{{ section.settings.jones_color_1 }}" },
        { "name": {{ section.settings.jones_color_2_name | json }}, "hex": "{{ section.settings.jones_color_2 }}" },
        { "name": {{ section.settings.jones_color_3_name | json }}, "hex": "{{ section.settings.jones_color_3 }}" },
        { "name": {{ section.settings.jones_color_4_name | json }}, "hex": "{{ section.settings.jones_color_4 }}" },
        { "name": {{ section.settings.jones_color_5_name | json }}, "hex": "{{ section.settings.jones_color_5 }}" },
        { "name": {{ section.settings.jones_color_6_name | json }}, "hex": "{{ section.settings.jones_color_6 }}" }
      ]
    }
  }
</script>

<style>
  /* NEW NEW NEW NEW NEW NEW NEW NEW NEW SWEATER DESIGNER */
  .sweater-designer {
    display: flex;
    padding: 0 1rem;
    gap: 0;
    max-width: 100%;
    width: 100%;
    position: relative;
    box-sizing: border-box;
    justify-content: space-around;
  }
  @media (max-width: 768px) {
    .sweater-designer {
      gap: 4rem;
      flex-direction: column;
      align-items: center;
    }
  }
  .sweater-designer_bottom {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
    margin-bottom: 2rem;
  }
  .sweater-designer_nav {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    gap: 1rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, sans-serif;
    position: relative;
  }
  .sweater-designer_control-buttons {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: center;
    cursor: pointer;
  }
  .sweater-designer_control-buttons span {
    text-decoration: none;
    font-size: 10px !important;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, sans-serif !important;
  }

  .sweater-designer_controls {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    order: 4;
  }

  /* NEW NEW NEW NEW NEW NEW NEW NEW NEW DETAILS PANEL */
  .controls-panel {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    padding: 2rem 0;
    width: 100%;
    max-width: 160px;
  }
  .controls-panel_price {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 100%;
  }

  @media (max-width: 768px) {
    .controls-panel {
      width: 100%;
      gap: 4rem;
      padding: 0 2rem;
      max-width: none;
    }
  }
  /* NEW NEW NEW NEW NEW NEW NEW NEW NEW MINI DESIGNER */
  .mini-designer-image {
    position: relative;
    width: 100%;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
  }
  .mini-designer-image span {
    text-decoration: none;
    font-size: 10px !important;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, sans-serif !important;

  }
  .mini-designer-image img, .mini-designer-image video {
    border: 6px solid black;
    aspect-ratio: 1 / 1;
  }

  /* NEW NEW NEW NEW NEW NEW NEW NEW NEW MODAL */
  #expanded-designer-overlay {
     background:rgba(0,0,0,0.66)
  }

  #expanded-content {
    position:relative;
    width: calc(100vw - 4vw);
    height: calc(100vh - 4vh);
    max-height: calc(100vh - 4vh);
    margin: 2vh auto;
    display: flex;
    flex-direction: column;
  }

  #carousel-container {
    flex: 1;
    position:relative;
    width:100%;
    background:#000;
  }

  #carousel-track {
    height: 100%;
    width: 100%;
    position: relative;
  }

  .carousel-slide {
    position: absolute !important;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .carousel-slide img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  #artist-info {
    flex-shrink: 0;
  }

  /* END END END END END END NEW NEW NEW NEW NEW NEW NEW NEW */


  /* Tutorial button */
  #tutorial-btn {
    position: absolute;
    top: 12px;
    left: 12px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #000;
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 18px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  @media (max-width: 768px) {
    #tutorial-btn {
      width: 24px;
      height: 24px;
      font-size: 14px;
      top: 8px;
      left: 8px;
    }
  }

  #tutorial-btn:hover {
    background: #333;
    transform: scale(1.1);
  }

  #tutorial-btn.playing {
    background: #ff4444;
    pointer-events: none;
  }

  /* Animated cursor */
  .tutorial-cursor {
    position: fixed;
    width: 24px;
    height: 24px;
    pointer-events: none;
    z-index: 10000;
    display: none;
  }

  .tutorial-cursor.active {
    display: block;
  }

  .tutorial-cursor svg {
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
  }

  /* Click animation */
  .tutorial-cursor.clicking {
    animation: clickPulse 0.3s ease;
  }

  @keyframes clickPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(0.9); }
  }

  /* Highlight elements during tutorial */
  .tutorial-highlight {
    position: relative;
  }

  .tutorial-highlight::after {
    content: '';
    position: absolute;
    top: -4px;
    left: -4px;
    right: -4px;
    bottom: -4px;
    border: 3px solid #66ff33;
    border-radius: inherit;
    pointer-events: none;
    animation: tutorialGlow 0.8s ease-in-out infinite;
    z-index: 50;
  }

  @keyframes tutorialGlow {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }

  /* Navigation button fix - remove any default styling */
  #prev-designer,
  #next-designer {
    background: transparent !important;
    background-color: transparent !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
  }

  #prev-designer:hover,
  #next-designer:hover,
  #prev-designer:focus,
  #next-designer:focus,
  #prev-designer:active,
  #next-designer:active {
    background: transparent !important;
    background-color: transparent !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
  }

  {% comment %} /* Desktop: hide left panel swatch container completely */
  #swatch-container {
    display: none !important;
  } {% endcomment %}

  /* Force select styling */
  select {
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    border-radius: 0 !important;
  }

  #sweater-size {
    border: 2px solid #000 !important;
    border-radius: 0 !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    background: #fff !important;
  }

  #sweater-size-mobile {
    border: 2px solid #000 !important;
    border-radius: 0 !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    background: #fff !important;
  }

  /* Color picker tooltip */
  #color-picker-tooltip {
    animation: tooltipFadeIn 0.3s ease;
  }

  @keyframes tooltipFadeIn {
    from { opacity: 0; transform: translateX(-50%) translateY(5px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }

  #expanded-designer-overlay {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Carousel styles */
  .carousel-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.3s ease;
    display: none;
  }

  .carousel-slide.active {
    opacity: 1;
    position: relative;
    display: flex !important;
    align-items: center;
    justify-content: center;
  }

  .carousel-video-slide video {
    max-width: 100%;
    max-height: 100%;
    width: 100%;
    height: 100%;
  }

  .carousel-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255,255,255,0.4);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .carousel-dot:hover {
    background: rgba(255,255,255,0.7);
  }

  .carousel-dot.active {
    background: #fff;
    transform: scale(1.2);
  }

  .carousel-dot-video {
    border-radius: 3px;
    width: 20px;
  }

  #carousel-prev:hover,
  #carousel-next:hover {
    background: #fff;
    transform: translateY(-50%) scale(1.1);
  }

  #carousel-sound-toggle:hover {
    background: rgba(0,0,0,0.9);
    transform: scale(1.1);
  }

  #carousel-sound-toggle.muted {
    background: rgba(255,0,0,0.7);
  }

  #carousel-sound-toggle.muted:hover {
    background: rgba(255,0,0,0.9);
  }

  #close-overlay-btn:hover {
    transform: scale(1.2);
  }

  /* Hide arrows when only one slide */
  #carousel-container.single-slide #carousel-prev,
  #carousel-container.single-slide #carousel-next,
  #carousel-container.single-slide #carousel-dots {
    display: none;
  }

  /* Hide wool image desktop on mobile */
  @media (max-width: 768px) {

    /* Make info tooltip much larger on mobile */
    #info-tooltip {
      max-width: 90vw !important;
      width: 90vw !important;
      max-height: 80vh !important;
      overflow-y: auto !important;
      padding: 20px !important;
    }

    /* Enlarge wool thumbnail image on mobile */
    #info-tooltip img {
      width: 100% !important;
      max-width: 100% !important;
      margin: 15px 0 !important;
    }

    #info-tooltip p {
      font-size: 12px !important;
      line-height: 1.5 !important;
      margin: 8px 0 !important;
    }

    #info-tooltip p:first-of-type {
      font-size: 16px !important;
      margin-bottom: 12px !important;
    }

    #carousel-prev,
    #carousel-next {
      width: 36px !important;
      height: 36px !important;
    }

    #artist-info {
      padding: 16px !important;
    }

    #expanded-designer-name {
      font-size: 20px !important;
    }

    #expanded-bio {
      font-size: 13px !important;
    }
  }

  /* Swatches & UI */
  #swatch-container {
    display: flex;
    flex-direction: row;
    gap: 12px;
    align-items: center;
    justify-content: center;
    background: none !important;
    border: none !important;
    padding: 0 !important;
    margin: 0 !important;
  }

  /* Combined sweater and swatches container */
  #sweater-and-swatches-container {
    border: 6px solid black;
    box-sizing: border-box;
    width: 100%;
    max-width: 860px;
    margin: 0 auto;
  }
  .color-swatch { width:36px; height:36px; border-radius:50%; cursor:pointer; border:1px solid #ccc; box-sizing:border-box; transition: transform .12s, border .12s; }
  .color-swatch.active { transform:scale(1.06); border:2px solid #000; }
  .sweater-layer:hover { cursor:pointer; stroke-width:3px; stroke:#000; }
  .over-limit { stroke:red !important; stroke-width:4px !important; vector-effect: non-scaling-stroke; }

  /* SVG sizing */
  #sweater-svg-wrapper {
    max-width: 100%;
    margin: 0 auto;
    box-sizing: border-box;
  }
  #sweater-svg { width:100%; height:auto; display:block; }

  /* Mobile controls grid - hidden on desktop */
  .mobile-controls-grid { display: contents; }

  #sweater-area {
    width: 100%;
    max-width: 860px;
    flex: 1 1 0%;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    position: relative;
    box-sizing: border-box;
  }
  #sweater-and-swatches-container {
    width: 100%;
  }

  /* Intermediate breakpoint (1200px to 1920px) for gradual scaling */
  @media (min-width: 1200px) and (max-width: 1919px) {

    #sweater-svg-wrapper {
      max-width: 100% !important;
    }
  }

  /* Large desktop screens (1920px+) */
  @media (min-width: 1920px) {

    #sweater-svg-wrapper {
      max-width: 1200px !important;
    }

    #sweater-and-swatches-container {
      max-width: 1200px !important;
    }

    #controls-panel button,
    #controls-panel select {
      width: 160px !important;
      font-size: 12px !important;
      padding: 12px 14px !important;
    }

    #wool-image {
      width: 160px !important;
      margin-top: 20px !important;
    }

    .color-swatch {
      width: 44px !important;
      height: 44px !important;
    }

    #designer-name {
      font-size: 22px !important;
    }
  }

  /* 4K screens (2560px+) - ENHANCED SCALING */
  @media (min-width: 2560px) {

    #sweater-svg-wrapper {
      max-width: 2400px !important;
    }

    #controls-panel {
      width: 280px !important;
      padding-top: 30px !important;
      gap: 16px !important;
    }

    #controls-panel button,
    #controls-panel select {
      width: 240px !important;
      font-size: 16px !important;
      padding: 16px 20px !important;
    }

    #mini-designer-image {
      width: 240px !important;
      height: 240px !important;
      border-width: 4px !important;
    }

    #wool-image {
      width: 240px !important;
      margin-top: 24px !important;
    }

    .color-swatch {
      width: 60px !important;
      height: 60px !important;
    }

    #designer-name {
      font-size: 30px !important;
    }

    #sweater-navigation button svg {
      width: 30px !important;
      height: 30px !important;
    }

    #controls-panel p {
      font-size: 20px !important;
      max-width: 200px !important;
    }

    #tutorial-btn {
      width: 44px !important;
      height: 44px !important;
      font-size: 24px !important;
      top: 16px !important;
      left: 16px !important;
    }
  }

  /* Ultra-wide 5K/6K screens (3440px+) */
  @media (min-width: 3440px) {

    #sweater-svg-wrapper {
      max-width: 3000px !important;
    }

    #sweater-and-swatches-container {
      max-width: 3000px !important;
    }

    #controls-panel {
      width: 320px !important;
    }

    #controls-panel button,
    #controls-panel select {
      width: 280px !important;
      font-size: 18px !important;
      padding: 18px 22px !important;
    }

    #mini-designer-image {
      width: 280px !important;
      height: 280px !important;
    }

    #wool-image {
      width: 280px !important;
    }

    .color-swatch {
      width: 70px !important;
      height: 70px !important;
    }
  }

  /* Enhanced responsive design */
  @media (max-width: 768px) {
    /* Prevent horizontal scroll on mobile */
    html, body {
      overflow-x: hidden !important;
      width: 100% !important;
    }

    #sweater-area {
      width: 100%;
      max-width: 100%;
      padding: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      position: relative;
      box-sizing: border-box;
    }

    /* Mobile Coming Soon Banner */
    #coming-soon-banner-mobile {
      order: 1;
      margin: 8px 0;
    }

    /* Sweater wrapper inside combined container */
    #sweater-svg-wrapper {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      transform-origin: center;
      max-height: 60vh;
      overflow: visible;
      box-sizing: border-box;
    }

    /* Navigation positioned after sweater */
    #sweater-navigation {
      position: relative;
      max-width: 100%;
      box-sizing: border-box;
    }

    /* Fixed zoom buttons in corners */
    #mobile-zoom-out {
      display: none !important;
    }

    #mobile-zoom-in {
      display: none !important;
    }

    /* Show mobile zoom buttons next to navigation */
    #sweater-navigation #mobile-zoom-out,
    #sweater-navigation #mobile-zoom-in {
      display: flex !important;
    }

    /* Swatches stay inside combined container on mobile */
    #swatch-container {
      display: flex !important;
      flex-direction: row !important;
      justify-content: center !important;
      gap: 8px !important;
      margin: 0 !important;
      padding: 0 !important;
      background: none !important;
      border: none !important;
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      box-sizing: border-box;
    }

    .color-swatch {
      width: 32px !important;
      height: 32px !important;
      min-width: 32px !important;
      border-width: 2px !important;
      flex-shrink: 0;
    }

    /* Mobile controls at bottom center */
    .mobile-controls-panel {
      order: 5;
      position: relative;
      width: calc(100% - 24px);
      max-width: 100%;
      background: white;
      padding: 12px;
      margin: 0 12px;
      border-top: none;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      box-sizing: border-box;
    }

    .mobile-instruction-text {
      font-size: 10px;
      color: #666;
      text-align: center;
      line-height: 1.3;
      margin: 0;
      padding: 0 12px;
      box-sizing: border-box;
    }

    /* Remove bottom padding since controls are now inline */
    body {
      padding-bottom: 0;
    }

    /* Ensure modals and overlays are within viewport */
    #sweater-confirm,
    #color-warning,
    #expanded-designer-overlay {
      max-width: 100% !important;
    }

    /* Color warning positioning */
    #color-warning {
      left: 16px !important;
      right: 16px !important;
      transform: none !important;
      width: auto !important;
    }
  }

  /* Desktop: hide mobile controls */
  @media (min-width: 769px) {
    .mobile-controls-panel {
      display: none !important;
    }

    #coming-soon-banner-mobile {
      display: none !important;
    }
  }

  /* Mobile: hide desktop coming soon banner */
  @media (max-width: 768px) {
    #coming-soon-banner {
      display: none !important;
    }
  }

  /* Prevent swatch container from appearing in right panel on any screen size */
  @media (max-width: 1200px) {
    #controls-panel #swatch-container {
      display: none !important;
    }
  }

  /* Touch device optimizations */
  @media (hover: none) {
    .sweater-layer:hover {
      cursor: default;
      stroke: none;
    }

    .sweater-layer:active {
      stroke: #007BFF;
      stroke-width: 3px;
    }

    .color-swatch {
      touch-action: manipulation;
    }
  }
  * Controls panel centering - desktop */
  @media (min-width: 1100px) {
    .sweater-designer {
      gap: 0 !important;
    }

    #controls-panel {
      position: absolute;
      right: calc((100vw - 860px) / 4 - 75px);
      top: 0;
    }
  }

  /* Intermediate sizes - keep panel next to sweater with gap */
  @media (min-width: 769px) and (max-width: 1099px) {
    .sweater-designer {
      gap: 24px !important;
      justify-content: center !important;
    }

    {% comment %} #controls-panel {
      position: relative !important;
      right: auto !important;
      margin-right: 0 !important;
    } {% endcomment %}
  }

  /* Deadline timer hover effect */
  #deadline-timer:hover {
    background: #000 !important;
  }

  #deadline-timer:hover #countdown-display {
    color: #fff !important;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', initSweaterDesigner);
document.addEventListener('shopify:section:load', initSweaterDesigner);

function initSweaterDesigner(){
  const root = document.querySelector('.sweater-designer');
  if(!root) return;
  if(root.dataset.sweaterInitialized) return;
  root.dataset.sweaterInitialized = '1';
  // ============================================
// COUNTDOWN TIMER FUNCTIONALITY
// ============================================

function updateCountdown() {
  // Deadline: Dec 19th, 2025, 00:00h (midnight)
  const deadline = new Date('2025-12-19T00:00:00').getTime();
  const now = new Date().getTime();
  const distance = deadline - now;
  
  const countdownDisplay = document.getElementById('countdown-display');
  
  if (distance < 0) {
    if (countdownDisplay) countdownDisplay.textContent = 'CLOSED';
    return;
  }
  
  const days = Math.floor(distance / (1000 * 60 * 60 * 24));
  const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((distance % (1000 * 60)) / 1000);
  
  const timeString = `${days}d ${hours}h ${minutes}m`;
  
  if (countdownDisplay) countdownDisplay.textContent = timeString;
}

// Update countdown every second
setInterval(updateCountdown, 1000);
updateCountdown(); // Initial call

// Hover tooltip for deadline timer
const timerContainer = document.getElementById('deadline-timer');
const timerTooltip = document.getElementById('deadline-tooltip');

if (timerContainer && timerTooltip) {
  timerContainer.addEventListener('mouseenter', () => timerTooltip.style.display = 'block');
  timerContainer.addEventListener('mouseleave', () => timerTooltip.style.display = 'none');
}

  // Load gallery data from Shopify settings
  let galleryData = {};
  try {
    const dataEl = document.getElementById('designer-gallery-data');
    if (dataEl) {
      galleryData = JSON.parse(dataEl.textContent);
    }
  } catch (e) {
    console.warn('Could not parse gallery data:', e);
  }
  

  // Designer configurations (colors now come from galleryData)
  const DESIGNERS = {
    0: {
      name: "David Hockney (60s)",
      available: true,
      defaults: {
        "hem":"#313539","neck":"#313539","Laag_2":"#313539","Laag_3":"#284354","Laag_4":"#b4a697","Laag_5":"#284354","Laag_6":"#313539",
        "Laag_7":"#284354","Laag_8":"#313539","Laag_9":"#6b5d93","Laag_10":"#9a6c2c","Laag_11":"#284354","Laag_12":"#313539",
        "Laag_13":"#313539","Laag_14":"#b4a697","Laag_15":"#313539","Laag_16":"#b3502e","Laag_17":"#313539","Laag_18":"#b4a697",
        "Laag_19":"#6b5d93","Laag_21":"#b3502e","Laag_22":"#313539","Laag_23":"#284354","Laag_24":"#b4a697","Laag_25":"#9a6c2c",
        "Laag_26":"#284354","Laag_27":"#313539","Laag_28":"#9a6c2c","leftcuff":"#313539","rightcuff":"#313539"
      },
      tooltipTitle: "David Hockney (60s)",
      tooltipImage: "https://cdn.shopify.com/s/files/1/0965/8233/6843/files/hockney60_430x.jpg?v=1762161908",
      fallbackThumbnail: "https://cdn.shopify.com/s/files/1/0965/8233/6843/files/Screenshot_2025-09-20_at_14.20.52_430x.png?v=1758370873#"
    },
    1: {
      name: "Francis Bacon",
      available: true,
      defaults: {
        "hem":"#8c6f64","neck":"#000000","Laag_2":"#8c6f64","Laag_3":"#1a352c","Laag_4":"#d8d5d2","Laag_5":"#d35968","Laag_6":"#1a352c",
        "Laag_7":"#d8d5d2","Laag_8":"#ff83a1","Laag_9":"#d35968","Laag_10":"#ff83a1","Laag_11":"#1a352c","Laag_12":"#d8d5d2",
        "Laag_13":"#000000","Laag_14":"#000000","Laag_15":"#1a352c","Laag_16":"#d35968","Laag_17":"#1a352c","Laag_18":"#d8d5d2",
        "Laag_19":"#1a352c","Laag_21":"#d35968","Laag_22":"#000000","Laag_23":"#000000","Laag_24":"#d8d5d2","Laag_25":"#000000",
        "Laag_26":"#ff83a1","Laag_27":"#8c6f64","Laag_28":"#ff83a1","leftcuff":"#8c6f64","rightcuff":"#8c6f64"
      },
      tooltipTitle: "Francis Bacon.",
      tooltipImage: "https://cdn.shopify.com/s/files/1/0965/8233/6843/files/bacon1_430x.jpg?v=1762164487",
      fallbackThumbnail: "https://cdn.shopify.com/s/files/1/0965/8233/6843/files/francisbacon_430x.jpg?v=1757588774#"
    },
    2: {
      name: "Ken Price",
      available: false,
      defaults: {
        "hem":"#000000",
    "neck":"#be4b2e",
    "Laag_2":"#000000",
    "Laag_3":"#843345",
    "Laag_4":"#59261f",
    "Laag_5":"#843345",
    "Laag_6":"#59261f",
    "Laag_7":"#9cbdb4",
    "Laag_8":"#59261f",
    "Laag_9":"#843345",
    "Laag_10":"#843345",
    "Laag_11":"#843345",
    "Laag_12":"#843345",
    "Laag_13":"#000000",
    "Laag_14":"#9cbdb4",
    "Laag_15":"#000000",
    "Laag_16":"#59261f",
    "Laag_17":"#9cbdb4",
    "Laag_18":"#7d90b2",
    "Laag_19":"#9cbdb4",
    "Laag_21":"#843345",
    "Laag_22":"#000000",
    "Laag_23":"#59261f",
    "Laag_24":"#9cbdb4",
    "Laag_25":"#7d90b2",
    "Laag_26":"#9cbdb4",
    "Laag_27":"#000000",
    "Laag_28":"#9cbdb4",
    "leftcuff":"#000000",
    "rightcuff":"#000000"
      },
      tooltipTitle: "Ken Price.",
      tooltipImage: "https://cdn.shopify.com/s/files/1/0965/8233/6843/files/kenprice1_430x.jpg?v=1762161907",
      fallbackThumbnail: "https://cdn.shopify.com/s/files/1/0965/8233/6843/files/Screenshot_2024-09-30_at_12.05.02_430x.png?v=1758355327"
    },
    3: {
      name: "David Hockney (2013)",
      available: true,
      defaults: {
        "hem":"#14352a",
    "neck":"#14352a",
    "Laag_2":"#14352a",
    "Laag_3":"#036433",
    "Laag_4":"#f2d075",
    "Laag_5":"#14352a",
    "Laag_6":"#036433",
    "Laag_7":"#7baa5e",
    "Laag_8":"#036433",
    "Laag_9":"#036433",
    "Laag_10":"#14352a",
    "Laag_11":"#036433",
    "Laag_12":"#036433",
    "Laag_13":"#14352a",
    "Laag_14":"#7baa5e",
    "Laag_15":"#14352a",
    "Laag_16":"#a40556",
    "Laag_17":"#7baa5e",
    "Laag_18":"#f2d075",
    "Laag_19":"#14352a",
    "Laag_21":"#890222",
    "Laag_22":"#14352a",
    "Laag_23":"#a40556",
    "Laag_24":"#f2d075",
    "Laag_25":"#a40556",
    "Laag_26":"#036433",
    "Laag_27":"#14352a",
    "Laag_28":"#7baa5e",
    "leftcuff":"#14352a",
    "rightcuff":"#14352a"
      },
      tooltipTitle: "David Hockney (2013)",
      tooltipImage: "https://cdn.shopify.com/s/files/1/0965/8233/6843/files/hockney13_430x.jpg?v=1762161907",
      fallbackThumbnail: "https://cdn.shopify.com/s/files/1/0965/8233/6843/files/2246_430x.webp?v=1758361067"
    },
    4: {
      name: "Natisa Jones",
      available: true,
      defaults: {
        "hem":"#6b191f",
    "neck":"#6b191f",
    "Laag_2":"#6b191f",
    "Laag_3":"#930918",
    "Laag_4":"#f1dbd0",
    "Laag_5":"#930918",
    "Laag_6":"#930918",
    "Laag_7":"#f1dbd0",
    "Laag_8":"#930918",
    "Laag_9":"#930918",
    "Laag_10":"#c32728",
    "Laag_11":"#930918",
    "Laag_12":"#930918",
    "Laag_13":"#6b191f",
    "Laag_14":"#c32728",
    "Laag_15":"#930918",
    "Laag_16":"#c32728",
    "Laag_17":"#6b191f",
    "Laag_18":"#c32728",
    "Laag_19":"#6b191f",
    "Laag_21":"#c32728",
    "Laag_22":"#6b191f",
    "Laag_23":"#000000",
    "Laag_24":"#c32728",
    "Laag_25":"#c32728",
    "Laag_26":"#c32728",
    "Laag_27":"#6b191f",
    "Laag_28":"#c32728",
    "leftcuff":"#6b191f",
    "rightcuff":"#6b191f"
      },
      tooltipTitle: "Natisa Jones.",
      tooltipImage: "https://cdn.shopify.com/s/files/1/0965/8233/6843/files/natisa1_430x.jpg?v=1762161907",
      fallbackThumbnail: "https://cdn.shopify.com/s/files/1/0965/8233/6843/files/natisagrowthspurt_430x.jpg?v=1762164815"
    }
  };

  // Helper function to get swatch colors for current designer
  function getSwatchColors(designerIndex) {
    const data = galleryData[designerIndex];
    if (data && data.colors && data.colors.length > 0) {
      return data.colors;
    }
    // Fallback to hardcoded defaults if settings not configured
    const fallbackColors = {
      0: [
        { name: "Purple", hex: "#6b5d93" },
        { name: "Dark Blue", hex: "#284354" },
        { name: "Charcoal", hex: "#313539" },
        { name: "Beige", hex: "#b4a697" },
        { name: "Rust Red", hex: "#b3502e" },
        { name: "Bronze", hex: "#9a6c2c" }
      ],
      1: [
        { name: "Rose", hex: "#d35968" },
        { name: "Pink", hex: "#ff83a1" },
        { name: "Brown", hex: "#8c6f64" },
        { name: "Forest", hex: "#1a352c" },
        { name: "Cream", hex: "#d8d5d2" },
        { name: "Black", hex: "#000000" }
      ],
      2: [
        { name: "Brown", hex: "#59261f" },
        { name: "Black", hex: "#000000" },
        { name: "Teal", hex: "#9cbdb4" },
        { name: "Rust", hex: "#be4b2e" },
        { name: "Blue", hex: "#7d90b2" },
        { name: "Burgundy", hex: "#843345" }
      ],
      3: [
        { name: "Crimson", hex: "#890222" },
        { name: "Magenta", hex: "#a40556" },
        { name: "Olive", hex: "#7baa5e" },
        { name: "Forest", hex: "#036433" },
        { name: "Dark Green", hex: "#14352a" },
        { name: "Yellow", hex: "#f2d075" }
      ],
      4: [
        { name: "Deep Red", hex: "#6b191f" },
        { name: "Bright Red", hex: "#c32728" },
        { name: "Crimson", hex: "#930918" },
        { name: "Peach", hex: "#f1dbd0" },
        { name: "Black", hex: "#000000" },
        { name: "Cream", hex: "#f3f2de" }
      ]
    };
    return fallbackColors[designerIndex] || fallbackColors[0];
  }

  // Current state
  let currentDesigner = 0;
  let activeColor = getSwatchColors(0)[0].hex;
  let currentCarouselIndex = 0;
  let carouselSlideCount = 0;

  // ============================================
  // CAROUSEL FUNCTIONALITY
  // ============================================
  
  const carouselContainer = document.getElementById('carousel-container');
  const carouselTrack = document.getElementById('carousel-track');
  const carouselPrev = document.getElementById('carousel-prev');
  const carouselNext = document.getElementById('carousel-next');
  const carouselDots = document.getElementById('carousel-dots');
  const carouselVideo = document.getElementById('carousel-video');
  const carouselSoundToggle = document.getElementById('carousel-sound-toggle');
  const soundOnIcon = document.getElementById('sound-on-icon');
  const soundOffIcon = document.getElementById('sound-off-icon');
  
  let isVideoMuted = false; // Track mute state
  
  function updateCarousel(designerIndex) {
    const data = galleryData[designerIndex] || {};
    const images = (data.images || []).filter(img => img && img !== '');
    const video = data.video || '';
    
    // Reset
    currentCarouselIndex = 0;
    
    // Build list of all slides (images + video)
    const slideContent = [];
    images.forEach((img, i) => {
      slideContent.push({ type: 'image', src: img, index: i });
    });
    if (video) {
      slideContent.push({ type: 'video', src: video, index: images.length });
    }
    
    carouselSlideCount = slideContent.length;
    
    // Update image slides
    for (let i = 0; i < 3; i++) {
      const img = document.getElementById(`carousel-img-${i}`);
      const slide = img?.parentElement;
      if (img && slide) {
        if (images[i]) {
          img.src = images[i];
          slide.style.display = 'none';
          slide.classList.remove('active');
          slide.dataset.index = i;
        } else {
          slide.style.display = 'none';
          slide.classList.remove('active');
        }
      }
    }
    
    // Update video slide
    const videoSlide = document.querySelector('.carousel-video-slide');
    if (video && carouselVideo && videoSlide) {
      // Reset video
      carouselVideo.pause();
      carouselVideo.src = video;
      carouselVideo.load();
      videoSlide.style.display = 'none';
      videoSlide.classList.remove('active');
      videoSlide.dataset.index = images.length;
    } else if (videoSlide) {
      videoSlide.style.display = 'none';
      videoSlide.classList.remove('active');
    }
    
    // Rebuild dots
    if (carouselDots) {
      carouselDots.innerHTML = '';
      slideContent.forEach((item, i) => {
        const dot = document.createElement('span');
        dot.className = 'carousel-dot' + (item.type === 'video' ? ' carousel-dot-video' : '');
        dot.dataset.index = i;
        if (i === 0) dot.classList.add('active');
        carouselDots.appendChild(dot);
      });
    }
    
    // Handle single slide or no slides case
    if (carouselSlideCount <= 1) {
      carouselContainer?.classList.add('single-slide');
    } else {
      carouselContainer?.classList.remove('single-slide');
    }
    
    // Show first slide
    if (carouselSlideCount > 0) {
      showSlide(0);
    }
  }
  
  function showSlide(index) {
    const data = galleryData[currentDesigner] || {};
    const images = (data.images || []).filter(img => img && img !== '');
    const hasVideo = !!(data.video);
    
    if (carouselSlideCount === 0) return;
    if (index < 0) index = carouselSlideCount - 1;
    if (index >= carouselSlideCount) index = 0;
    currentCarouselIndex = index;
    
    const videoSlideIndex = hasVideo ? images.length : -1;
    const isOnVideoSlide = (index === videoSlideIndex);
    
    // Show/hide sound toggle based on whether we're on video slide
    if (carouselSoundToggle) {
      carouselSoundToggle.style.display = isOnVideoSlide ? 'flex' : 'none';
    }
    
    // Hide all slides first
    const allSlides = carouselTrack?.querySelectorAll('.carousel-slide');
    allSlides?.forEach(slide => {
      slide.classList.remove('active');
      slide.style.display = 'none';
    });
    
    // Pause video
    if (carouselVideo) {
      carouselVideo.pause();
    }
    
    // Show the correct slide
    if (index < images.length) {
      // It's an image slide
      const imgSlide = document.getElementById(`carousel-img-${index}`)?.parentElement;
      if (imgSlide) {
        imgSlide.style.display = 'flex';
        imgSlide.classList.add('active');
      }
    } else if (hasVideo && isOnVideoSlide) {
      // It's the video slide
      const videoSlide = document.querySelector('.carousel-video-slide');
      if (videoSlide) {
        videoSlide.style.display = 'flex';
        videoSlide.classList.add('active');
        // Autoplay video with current mute state
        if (carouselVideo) {
          carouselVideo.muted = isVideoMuted;
          carouselVideo.play().catch(e => console.log('Autoplay prevented:', e));
        }
      }
    }
    
    // Update dots
    const dots = carouselDots?.querySelectorAll('.carousel-dot');
    dots?.forEach((dot, i) => {
      dot.classList.toggle('active', i === index);
    });
  }
  
  carouselPrev?.addEventListener('click', (e) => {
    e.stopPropagation();
    showSlide(currentCarouselIndex - 1);
  });
  
  carouselNext?.addEventListener('click', (e) => {
    e.stopPropagation();
    showSlide(currentCarouselIndex + 1);
  });
  
  carouselDots?.addEventListener('click', (e) => {
    const dot = e.target.closest('.carousel-dot');
    if (dot) {
      e.stopPropagation();
      const index = parseInt(dot.dataset.index);
      if (!isNaN(index)) {
        showSlide(index);
      }
    }
  });
  
  // Sound toggle functionality
  carouselSoundToggle?.addEventListener('click', (e) => {
    e.stopPropagation();
    if (carouselVideo) {
      isVideoMuted = !isVideoMuted;
      carouselVideo.muted = isVideoMuted;
      updateSoundIcon();
    }
  });
  
  function updateSoundIcon() {
    if (isVideoMuted) {
      soundOnIcon.style.display = 'none';
      soundOffIcon.style.display = 'block';
      carouselSoundToggle?.classList.add('muted');
    } else {
      soundOnIcon.style.display = 'block';
      soundOffIcon.style.display = 'none';
      carouselSoundToggle?.classList.remove('muted');
    }
  }
  
  // Keyboard navigation for carousel
  document.addEventListener('keydown', (e) => {
    if (expandedOverlay?.style.display === 'block') {
      if (e.key === 'ArrowLeft') showSlide(currentCarouselIndex - 1);
      if (e.key === 'ArrowRight') showSlide(currentCarouselIndex + 1);
      if (e.key === 'Escape') closeExpandedOverlay();
      // M key to toggle mute
      if (e.key === 'm' || e.key === 'M') {
        if (carouselVideo && carouselSoundToggle?.style.display === 'flex') {
          isVideoMuted = !isVideoMuted;
          carouselVideo.muted = isVideoMuted;
          updateSoundIcon();
        }
      }
    }
  });

  // ============================================
  // EXPANDED OVERLAY WITH ARTIST INFO
  // ============================================
  
  const expandedOverlay = document.getElementById('expanded-designer-overlay');
  const expandedName = document.getElementById('expanded-designer-name');
  const expandedPaintingName = document.getElementById('expanded-painting-name');
  const expandedBio = document.getElementById('expanded-bio');
  const expandedWikipedia = document.getElementById('expanded-wikipedia');
  const closeOverlayBtn = document.getElementById('close-overlay-btn');
  
  function openExpandedOverlay(designerIndex) {
    const designer = DESIGNERS[designerIndex];
    const data = galleryData[designerIndex] || {};
    
    // Update carousel
    updateCarousel(designerIndex);
    
    // Update artist info
    if (expandedName) expandedName.textContent = designer.name;
    if (expandedPaintingName) expandedPaintingName.textContent = data.paintingName || '';
    if (expandedBio) expandedBio.textContent = data.bio || '';
    
    if (expandedWikipedia) {
      if (data.wikipedia) {
        expandedWikipedia.href = data.wikipedia;
        expandedWikipedia.style.display = 'inline-flex';
      } else {
        expandedWikipedia.style.display = 'none';
      }
    }
    
    if (expandedOverlay) expandedOverlay.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Check if we should start with video
    const images = (data.images || []).filter(img => img && img !== '');
    const hasVideo = !!(data.video);
    if (data.startWithVideo && hasVideo) {
      // Jump to video slide
      const videoSlideIndex = images.length;
      showSlide(videoSlideIndex);
    }
  }
  
  function closeExpandedOverlay() {
    if (expandedOverlay) expandedOverlay.style.display = 'none';
    document.body.style.overflow = '';
    if (carouselVideo) {
      carouselVideo.pause();
      carouselVideo.currentTime = 0;
    }
    // Hide sound toggle
    if (carouselSoundToggle) {
      carouselSoundToggle.style.display = 'none';
    }
  }
  
  closeOverlayBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    closeExpandedOverlay();
  });
  
  expandedOverlay?.addEventListener('click', (e) => {
    if (e.target === expandedOverlay) {
      closeExpandedOverlay();
    }
  });
  
  // Prevent clicks inside content from closing
  document.getElementById('expanded-content')?.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // ============================================
  // VIDEO THUMBNAIL FUNCTIONALITY
  // ============================================
  
  const miniDesignerVideo = document.getElementById('mini-designer-video');
  const miniDesignerVideoMobile = document.getElementById('mini-designer-video-mobile');
  let videoPreviewTimer = null;
  
  function updateMiniThumbnail(designerIndex) {
    const designer = DESIGNERS[designerIndex];
    const data = galleryData[designerIndex] || {};
    
    const miniImg = document.getElementById('mini-designer-img');
    const miniImgMobile = document.getElementById('mini-designer-img-mobile');
    
    // Clear any existing video preview timer
    if (videoPreviewTimer) {
      clearInterval(videoPreviewTimer);
      videoPreviewTimer = null;
    }
    
    // Check if we should use video as thumbnail
    if (data.videoAsThumbnail && data.video) {
      // Desktop
      if (miniDesignerVideo && miniImg) {
        miniDesignerVideo.src = data.video;
        miniDesignerVideo.style.display = 'block';
        miniImg.style.display = 'none';
        
        if (data.videoPreview) {
          // 5-second preview loop
          miniDesignerVideo.currentTime = 0;
          miniDesignerVideo.play().catch(() => {});
          
          videoPreviewTimer = setInterval(() => {
            if (miniDesignerVideo.currentTime >= 5) {
              miniDesignerVideo.currentTime = 0;
            }
          }, 100);
        } else {
          // Just show first frame (poster)
          miniDesignerVideo.currentTime = 0;
          miniDesignerVideo.pause();
        }
      }
      
      // Mobile
      if (miniDesignerVideoMobile && miniImgMobile) {
        miniDesignerVideoMobile.src = data.video;
        miniDesignerVideoMobile.style.display = 'block';
        miniImgMobile.style.display = 'none';
        
        if (data.videoPreview) {
          miniDesignerVideoMobile.currentTime = 0;
          miniDesignerVideoMobile.play().catch(() => {});
        }
      }
    } else {
      // Use image thumbnail - prefer from settings, fallback to hardcoded
      const imageUrl = data.thumbnail || designer.fallbackThumbnail;
      
      if (miniImg) {
        miniImg.src = imageUrl;
        miniImg.style.display = 'block';
      }
      if (miniDesignerVideo) {
        miniDesignerVideo.style.display = 'none';
        miniDesignerVideo.pause();
      }
      
      if (miniImgMobile) {
        miniImgMobile.src = imageUrl;
        miniImgMobile.style.display = 'block';
      }
      if (miniDesignerVideoMobile) {
        miniDesignerVideoMobile.style.display = 'none';
        miniDesignerVideoMobile.pause();
      }
    }
  }

  // ============================================
  // PALETTE SELECTOR INTEGRATION
  // ============================================
  
  document.addEventListener('paletteSelected', function(e) {
    const newDesignerIndex = e.detail.designerIndex;
    if (newDesignerIndex !== currentDesigner && DESIGNERS[newDesignerIndex]) {
      switchDesigner(newDesignerIndex);
    }
  });

  const maxBodyColors = 4;
  const maxSleeveColors = 5;

  // Layer categories
  const bodyLayers = ["Laag_3","Laag_4","Laag_5","Laag_6","Laag_7","Laag_8","Laag_9","Laag_11","Laag_12","Laag_15"];
  const leftSleeveLayers = ["Laag_10","Laag_14","Laag_16","Laag_17","Laag_18","Laag_19"];
  const rightSleeveLayers = ["Laag_21","Laag_28","Laag_23","Laag_24","Laag_25","Laag_26"];
  const hemLayers = ["Laag_2","Laag_13","Laag_22","Laag_27","hem","neck","leftcuff","rightcuff","leftcuff-2"];
  
  const sleeveLayers = [...leftSleeveLayers, ...rightSleeveLayers];

  // elements
  const swatchContainer = document.getElementById('swatch-container');
  const infoBtn = document.getElementById('info-btn');
  const tooltip = document.getElementById('info-tooltip');
  const addBtn = document.getElementById('add-to-cart');
  const defaultBtn = document.getElementById('default-btn');
  const randomBtn = document.getElementById('random-btn');
  const nameInput = document.getElementById('custom-name');
  const nameLabel = document.getElementById('name-label-preview');
  const svg = document.getElementById('sweater-svg');
  const sizeSelect = document.getElementById('sweater-size');
  const confirmPanel = document.getElementById('sweater-confirm');
  const confirmGo = document.getElementById('sweater-confirm-go');
  const confirmKeep = document.getElementById('sweater-confirm-keep');
  const colorWarning = document.getElementById('color-warning');
  const colorWarningText = document.getElementById('color-warning-text');
  const nextDesignerBtn = document.getElementById('next-designer');
  const prevDesignerBtn = document.getElementById('prev-designer');
  const designerNameEl = document.getElementById('designer-name');
  
  // Get the single product variant ID
  const productVariantIdInput = document.getElementById('product-variant-id');
  let SINGLE_VARIANT_ID = productVariantIdInput ? productVariantIdInput.value : null;
  
  // Clean up the variant ID (remove any whitespace)
  if (SINGLE_VARIANT_ID) {
    SINGLE_VARIANT_ID = SINGLE_VARIANT_ID.trim();
    if (SINGLE_VARIANT_ID === '' || SINGLE_VARIANT_ID === 'null' || SINGLE_VARIANT_ID === 'undefined') {
      SINGLE_VARIANT_ID = null;
    }
  }
  
  // Debug panel toggle (Ctrl+D)
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'd') {
      e.preventDefault();
      const debugPanel = document.getElementById('debug-info');
      if (debugPanel) {
        debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
      }
    }
  });
  
  // Update debug info
  const debugProduct = document.getElementById('debug-product');
  const debugVariant = document.getElementById('debug-variant');
  if (debugProduct) debugProduct.textContent = '{% if section.settings.sweater_product %}{{ section.settings.sweater_product.title }}{% else %}Not configured{% endif %}';
  if (debugVariant) debugVariant.textContent = SINGLE_VARIANT_ID || 'Not found';
  
  console.log('=== SWEATER DESIGNER DEBUG ===');
  console.log('Product configured:', '{% if section.settings.sweater_product %}Yes - {{ section.settings.sweater_product.title }}{% else %}No{% endif %}');
  console.log('Raw variant value from input:', productVariantIdInput ? productVariantIdInput.value : 'input not found');
  console.log('Cleaned variant ID:', SINGLE_VARIANT_ID);
  console.log('Variant ID type:', typeof SINGLE_VARIANT_ID);
  console.log('Section settings product:', {% if section.settings.sweater_product %}true{% else %}false{% endif %});
  console.log('Fallback variant ID:', '{{ section.settings.fallback_variant_id }}');
  console.log('Press Ctrl+D to show debug panel');
  console.log('==============================');
  
  // Mini designer image elements
  const miniDesignerImage = document.getElementById('mini-designer-image');
  const miniDesignerImg = document.getElementById('mini-designer-img');
  const miniDesignerImageMobile = document.getElementById('mini-designer-image-mobile');
  const miniDesignerImgMobile = document.getElementById('mini-designer-img-mobile');

  // Mini designer image click handlers
  function setupMiniImageClick(element) {
    if (element) {
      element.addEventListener('click', () => {
        openExpandedOverlay(currentDesigner);
      });
    }
  }
  
  setupMiniImageClick(miniDesignerImage);
  setupMiniImageClick(miniDesignerImageMobile);

  function switchDesigner(designerIndex) {
    if (!DESIGNERS[designerIndex]) return;
    
    currentDesigner = designerIndex;
    const designer = DESIGNERS[currentDesigner];
    
    designerNameEl.textContent = designer.name;
    updateMiniThumbnail(designerIndex);
    
    prevDesignerBtn.style.opacity = currentDesigner === 0 ? '0.3' : '1';
    nextDesignerBtn.style.opacity = currentDesigner === Object.keys(DESIGNERS).length - 1 ? '0.3' : '1';
    
    updateAddToCartButton();
    buildSwatches();
    applyDefaults();
    refreshConstraints();
    syncMobileButtons();
    
    // Dispatch event to update palette selector
    const event = new CustomEvent('designerChanged', { 
      detail: { designerIndex: currentDesigner } 
    });
    document.dispatchEvent(event);
  }

  function updateAddToCartButton() {
    const designer = DESIGNERS[currentDesigner];
    const buttons = [
      {btn: addBtn, tooltipId: 'coming-soon-tooltip'},
      {btn: document.getElementById('add-to-cart-mobile'), tooltipId: 'coming-soon-tooltip-mobile'}
    ];
    
    buttons.forEach(({btn, tooltipId}) => {
      if (!btn) return;
      
      // Remove existing tooltip if present
      const existingTooltip = document.getElementById(tooltipId);
      if (existingTooltip) existingTooltip.remove();
      
      if (!designer.available) {
        btn.textContent = 'NOTIFY ME';
        btn.style.background = '#FF6B35';
        btn.style.color = '#fff';
        btn.style.cursor = 'pointer';
        btn.disabled = false;
        btn.style.position = 'relative';
        
        // Create tooltip element (hidden by default)
        const tooltip = document.createElement('div');
        tooltip.id = tooltipId;
        tooltip.textContent = 'Coming Soon';
        tooltip.style.cssText = 'position: absolute; bottom: 105%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; white-space: nowrap; pointer-events: none; z-index: 1000; opacity: 0; transition: opacity 0.2s;';
        
        // Add arrow
        const arrow = document.createElement('div');
        arrow.style.cssText = 'position: absolute; top: 100%; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #333;';
        tooltip.appendChild(arrow);
        
        btn.appendChild(tooltip);
        
        // Show tooltip on hover
        btn.addEventListener('mouseenter', () => {
          tooltip.style.opacity = '1';
        });
        btn.addEventListener('mouseleave', () => {
          tooltip.style.opacity = '0';
        });
      } else {
        btn.textContent = 'ADD TO BAG';
        btn.style.background = '#0090C1';
        btn.style.color = '#fff';
        btn.style.cursor = 'pointer';
        btn.disabled = false;
        btn.style.position = '';
      }
    });
  }

  function syncMobileButtons() {
    const mobileAddBtn = document.getElementById('add-to-cart-mobile');
    const mobileDefaultBtn = document.getElementById('default-btn-mobile');
    const mobileRandomBtn = document.getElementById('random-btn-mobile');
    const mobileInfoBtn = document.getElementById('info-btn-mobile');
    const mobileSizeSelect = document.getElementById('sweater-size-mobile');
    const mobileZoomIn = document.getElementById('mobile-zoom-in');
    const mobileZoomOut = document.getElementById('mobile-zoom-out');
    
    if (window.innerWidth <= 768) {
      if (mobileZoomIn) mobileZoomIn.style.display = 'flex';
      if (mobileZoomOut) mobileZoomOut.style.display = 'flex';
    }
    
    if (mobileAddBtn) {
      mobileAddBtn.replaceWith(mobileAddBtn.cloneNode(true));
      const newMobileAddBtn = document.getElementById('add-to-cart-mobile');
      newMobileAddBtn.addEventListener('click', (e) => {
        if (mobileSizeSelect && sizeSelect) {
          sizeSelect.value = mobileSizeSelect.value;
        }
        addBtn.click();
      });
    }
    
    if (mobileDefaultBtn) {
      mobileDefaultBtn.replaceWith(mobileDefaultBtn.cloneNode(true));
      const newMobileDefaultBtn = document.getElementById('default-btn-mobile');
      newMobileDefaultBtn.addEventListener('click', () => defaultBtn.click());
    }
    
    if (mobileRandomBtn) {
      mobileRandomBtn.replaceWith(mobileRandomBtn.cloneNode(true));
      const newMobileRandomBtn = document.getElementById('random-btn-mobile');
      newMobileRandomBtn.addEventListener('click', () => randomBtn.click());
    }
    
    if (mobileInfoBtn) {
      mobileInfoBtn.replaceWith(mobileInfoBtn.cloneNode(true));
      const newMobileInfoBtn = document.getElementById('info-btn-mobile');
      newMobileInfoBtn.addEventListener('mouseenter', () => infoBtn.dispatchEvent(new Event('mouseenter')));
      newMobileInfoBtn.addEventListener('mouseleave', () => infoBtn.dispatchEvent(new Event('mouseleave')));
    }
    
    if (mobileZoomIn) {
      mobileZoomIn.replaceWith(mobileZoomIn.cloneNode(true));
      const newMobileZoomIn = document.getElementById('mobile-zoom-in');
      newMobileZoomIn.addEventListener('click', () => {
        if (currentZoom < maxZoom) {
          currentZoom = Math.min(maxZoom, currentZoom + zoomStep);
          updateZoom();
        }
      });
    }
    
    if (mobileZoomOut) {
      mobileZoomOut.replaceWith(mobileZoomOut.cloneNode(true));
      const newMobileZoomOut = document.getElementById('mobile-zoom-out');
      newMobileZoomOut.addEventListener('click', () => {
        if (currentZoom > minZoom) {
          currentZoom = Math.max(minZoom, currentZoom - zoomStep);
          updateZoom();
        }
      });
    }
    
    setTimeout(() => {
      updateAddToCartButton();
    }, 100);
  }

  // Zoom functionality
  let currentZoom = 1;
  const minZoom = 0.8;
  const maxZoom = 2.5;
  const zoomStep = 0.2;

  function updateZoom() {
    const sweaterWrapper = document.getElementById('sweater-svg-wrapper');
    if (sweaterWrapper) {
      sweaterWrapper.style.transform = `scale(${currentZoom})`;
      
      const mobileZoomOut = document.getElementById('mobile-zoom-out');
      const mobileZoomIn = document.getElementById('mobile-zoom-in');
      
      if (mobileZoomOut) mobileZoomOut.style.opacity = currentZoom <= minZoom ? '0.5' : '1';
      if (mobileZoomIn) mobileZoomIn.style.opacity = currentZoom >= maxZoom ? '0.5' : '1';
    }
  }

  if (nextDesignerBtn) {
    nextDesignerBtn.addEventListener('click', () => {
      if (currentDesigner < Object.keys(DESIGNERS).length - 1) {
        switchDesigner(currentDesigner + 1);
      }
    });
  }
  
  if (prevDesignerBtn) {
    prevDesignerBtn.addEventListener('click', () => {
      if (currentDesigner > 0) {
        switchDesigner(currentDesigner - 1);
      }
    });
  }

  function normalizeColor(c) {
    if(!c) return c;
    c = String(c).trim().toLowerCase();
    if(c.indexOf('rgb') === 0) {
      const nums = c.replace(/rgba?|\(|\)|\s/g,'').split(',').map(n=>parseInt(n,10)||0);
      if(nums.length>=3) c = '#' + nums.slice(0,3).map(n=>n.toString(16).padStart(2,'0')).join('');
    }
    const blacks = ['#000','#000000','black','#050505','#1d1d1b','#070606'];
    if(blacks.includes(c)) return '#000000';
    return c;
  }

  function buildSwatches() {
    const swatchColors = getSwatchColors(currentDesigner);
    swatchContainer.innerHTML = '';
    activeColor = swatchColors[0].hex;
    
    swatchColors.forEach((colorObj, i) => {
      const sw = document.createElement('div');
      sw.className = 'color-swatch' + (i === 0 ? ' active' : '');
      sw.style.backgroundColor = colorObj.hex;
      sw.title = colorObj.name + ' (' + colorObj.hex + ')';
      sw.addEventListener('click', () => {
        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
        sw.classList.add('active');
        activeColor = colorObj.hex;
      });
      swatchContainer.appendChild(sw);
    });
  }

  function getFirstShapeById(id) {
    const g = document.getElementById(id);
    if(!g) return null;
    return g.querySelector('path, rect, polygon, polyline, circle, ellipse');
  }

  function applyDefaults() {
    const designer = DESIGNERS[currentDesigner];
    
    Object.keys(designer.defaults).forEach(layerId=>{
      const g = document.getElementById(layerId);
      if(!g) return;
      g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(s=>{
        s.style.fill = designer.defaults[layerId];
      });
    });
    ['hem','neck','leftcuff','rightcuff','leftcuff-2'].forEach(id=>{
      const g = document.getElementById(id);
      if(!g) return;
      const def = designer.defaults[id] || designer.defaults['hem'] || '#8c6f64';
      g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(s=> s.style.fill = def);
    });
    refreshConstraints();
  }

  function makeShapesClickable() {
    const allIds = new Set(Object.keys(DESIGNERS[0].defaults));
    bodyLayers.forEach(x=>allIds.add(x));
    sleeveLayers.forEach(x=>allIds.add(x));
    hemLayers.forEach(x=>allIds.add(x));
    ['hem','neck','leftcuff','rightcuff','leftcuff-2'].forEach(x=>allIds.add(x));

    allIds.forEach(layerId=>{
      const g = document.getElementById(layerId);
      if(!g) return;
      const shapes = g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse');
      shapes.forEach(s=>{
        s.classList.add('sweater-layer');
        if(!(s.style && s.style.fill)) {
          const attr = s.getAttribute('fill');
          if(attr) s.style.fill = normalizeColor(attr);
        } else {
          s.style.fill = normalizeColor(s.style.fill);
        }
        s.addEventListener('click', function(){
          if(!activeColor) return;
          s.style.fill = normalizeColor(activeColor);
          refreshConstraints();
        });
      });
    });
  }

  function getFill(layerId) {
    const s = getFirstShapeById(layerId);
    if(!s) return null;
    const f = (s.style && s.style.fill) ? s.style.fill : s.getAttribute('fill');
    return normalizeColor(f);
  }

  function uniqueColors(layers) {
    const set = new Set();
    layers.forEach(l=>{
      const f = getFill(l);
      if(f) set.add(f);
    });
    return Array.from(set);
  }

  function refreshConstraints() {
    const bodyUsed = uniqueColors(bodyLayers);
    const leftSleeveUsed = uniqueColors(leftSleeveLayers);
    const rightSleeveUsed = uniqueColors(rightSleeveLayers);

    [...bodyLayers,...leftSleeveLayers,...rightSleeveLayers].forEach(layerId=>{
      const g = document.getElementById(layerId);
      if(!g) return;
      g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(s=> s.classList.remove('over-limit'));
    });

    let exceeded = false;
    let warningMessages = [];

    if(bodyUsed.length > maxBodyColors) {
      exceeded = true;
      warningMessages.push(`Body: ${bodyUsed.length}/${maxBodyColors} colors`);
      bodyLayers.forEach(layerId=>{
        const g = document.getElementById(layerId);
        if(!g) return;
        g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(s=> s.classList.add('over-limit'));
      });
    }

    if(leftSleeveUsed.length > maxSleeveColors) {
      exceeded = true;
      warningMessages.push(`Left sleeve: ${leftSleeveUsed.length}/${maxSleeveColors} colors`);
      leftSleeveLayers.forEach(layerId=>{
        const g = document.getElementById(layerId);
        if(!g) return;
        g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(s=> s.classList.add('over-limit'));
      });
    }

    if(rightSleeveUsed.length > maxSleeveColors) {
      exceeded = true;
      warningMessages.push(`Right sleeve: ${rightSleeveUsed.length}/${maxSleeveColors} colors`);
      rightSleeveLayers.forEach(layerId=>{
        const g = document.getElementById(layerId);
        if(!g) return;
        g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(s=> s.classList.add('over-limit'));
      });
    }

    if(exceeded && warningMessages.length > 0) {
      colorWarningText.textContent = 'Too many colors: ' + warningMessages.join(', ');
      colorWarning.style.display = 'block';
    } else {
      colorWarning.style.display = 'none';
    }

    if(addBtn) {
      addBtn.disabled = exceeded;
      addBtn.style.background = exceeded ? '#ccc' : '#0090C1';
      addBtn.style.cursor = exceeded ? 'default' : 'pointer';
    }
  }

  function randomizeWithinConstraints() {
    const swatchColors = getSwatchColors(currentDesigner);
    const availableColors = swatchColors.map(c => c.hex);
    
    const bodyPalette = availableColors.slice(0, Math.min(maxBodyColors, availableColors.length));
    bodyLayers.forEach(l=>{
      const g = document.getElementById(l);
      if(!g) return;
      const col = bodyPalette[Math.floor(Math.random()*bodyPalette.length)];
      g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(s=> s.style.fill = col);
    });

    const leftSleevePalette = availableColors.slice(0, Math.min(maxSleeveColors, availableColors.length));
    leftSleeveLayers.forEach(l=>{
      const g = document.getElementById(l);
      if(!g) return;
      const col = leftSleevePalette[Math.floor(Math.random()*leftSleevePalette.length)];
      g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(s=> s.style.fill = col);
    });

    const rightSleevePalette = availableColors.slice(0, Math.min(maxSleeveColors, availableColors.length));
    rightSleeveLayers.forEach(l=>{
      const g = document.getElementById(l);
      if(!g) return;
      const col = rightSleevePalette[Math.floor(Math.random()*rightSleevePalette.length)];
      g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(s=> s.style.fill = col);
    });

    hemLayers.forEach(l=>{
      const g = document.getElementById(l);
      if(!g) return;
      const col = availableColors[Math.floor(Math.random()*availableColors.length)];
      g.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(s=> s.style.fill = col);
    });

    refreshConstraints();
  }

  if(defaultBtn) defaultBtn.addEventListener('click', applyDefaults);
  if(randomBtn) randomBtn.addEventListener('click', randomizeWithinConstraints);

  if(infoBtn && tooltip) {
    infoBtn.addEventListener('mouseenter', ()=> {
      const designer = DESIGNERS[currentDesigner];
      tooltip.querySelector('p').textContent = designer.tooltipTitle;
      tooltip.querySelector('img').src = designer.tooltipImage;
      tooltip.style.display = 'block';
    });
    infoBtn.addEventListener('mouseleave', ()=> tooltip.style.display = 'none');
  }

  if(nameInput) {
    nameInput.addEventListener('keypress', function(e){
      if(e.key === 'Enter') {
        nameLabel.textContent = nameInput.value || '';
        nameInput.blur();
      }
    });
  }

  function showConfirmation() {
    if(!confirmPanel) return;
    confirmPanel.style.display = 'block';
    clearTimeout(confirmPanel._hideTimer);
    confirmPanel._hideTimer = setTimeout(()=> confirmPanel.style.display = 'none', 6000);
  }
  if(confirmGo) confirmGo.addEventListener('click', ()=> window.location.href = "/cart");
  if(confirmKeep) confirmKeep.addEventListener('click', ()=> { if(confirmPanel) confirmPanel.style.display = 'none'; });

  async function svgToPngDataUrl(svgNode, maxWidth = 1000) {
    if(!svgNode) throw new Error('SVG not found for export');
    const clone = svgNode.cloneNode(true);
    clone.querySelectorAll('path, rect, polygon, polyline, circle, ellipse').forEach(el=>{
      const f = (el.style && el.style.fill) ? el.style.fill : el.getAttribute('fill');
      if(f) el.setAttribute('fill', f);
    });

    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(clone);
    const encoded = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
    const img = new Image();
    img.src = encoded;
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });

    let vbW = null, vbH = null;
    const vb = svgNode.getAttribute('viewBox');
    if(vb) {
      const parts = vb.trim().split(/\s+/).map(Number);
      if(parts.length === 4 && parts[2] && parts[3]) {
        vbW = parts[2]; vbH = parts[3];
      }
    }

    const dispW = svgNode.clientWidth || svgNode.getBoundingClientRect().width || maxWidth;
    const dispH = svgNode.clientHeight || svgNode.getBoundingClientRect().height || (dispW * 9/16);

    let canvasW, canvasH;
    if(vbW && vbH) {
      const scale = Math.min(maxWidth / vbW, 1.5);
      canvasW = Math.round(vbW * scale);
      canvasH = Math.round(vbH * scale);
    } else {
      const ratio = dispW && dispH ? (dispH/dispW) : (9/16);
      canvasW = Math.round(Math.min(maxWidth, dispW));
      canvasH = Math.round(canvasW * ratio);
    }

    const canvas = document.createElement('canvas');
    canvas.width = canvasW;
    canvas.height = canvasH;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL('image/png', 0.9);
  }

  if(addBtn) addBtn.addEventListener('click', async function(e){
    e.preventDefault();
    
    const designer = DESIGNERS[currentDesigner];

    if (!designer.available) {
      const userEmail = prompt(`Enter your email to be notified when ${designer.name} becomes available:`);
      
      if (!userEmail || !userEmail.includes('@')) {
        if (userEmail !== null) alert('Please enter a valid email address');
        return;
      }
      
      addBtn.disabled = true;
      addBtn.textContent = 'Saving...';
      
      try {
        const pngDataUrl = await svgToPngDataUrl(svg, 1000);
        const sizeText = sizeSelect ? sizeSelect.value : 'M';
        
        const response = await fetch('https://uploads.pabon.shop/waitlist_handler.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: userEmail,
            designer: designer.name,
            size: sizeText,
            designImage: pngDataUrl
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(result.message + '\n\n' + result.total_interested + ' people interested in this colorway!');
        } else {
          alert('Error: ' + result.message);
        }
      } catch (err) {
        alert('Failed to save notification: ' + err.message);
      } finally {
        addBtn.disabled = false;
        addBtn.textContent = 'NOTIFY ME';
      }
      return;
    }
    
    if(addBtn.disabled) {
      alert('Cannot add to cart: color constraints exceeded. Please reduce the number of colors used.');
      return;
    }
    
    // Check if we have a product variant ID
    if (!SINGLE_VARIANT_ID) {
      alert('⚠️ Product not configured!\n\nPlease follow these steps:\n\n1. Go to Customize Theme\n2. Click on the Sweater Designer section\n3. Select your sweater product\n4. Save\n\nOr paste a Variant ID in the Fallback field.\n\nPress Ctrl+D to see debug info.');
      console.error('No variant ID found. Configure the section settings or check the console for details.');
      return;
    }
    
    if(addBtn.dataset.busy === '1') return;
    addBtn.dataset.busy = '1';
    addBtn.style.opacity = '0.6';
    const origText = addBtn.textContent;
    addBtn.textContent = 'Processing...';

    try {
      if(!svg) throw new Error('SVG not found.');

      const pngDataUrl = await svgToPngDataUrl(svg, 1000);
      
      // Always use the single variant ID
      const chosenVariant = SINGLE_VARIANT_ID;

      const timestamp = Date.now();
      const designerClean = designer.name.replace(/\s+/g, '_');
      const designId = `${designerClean}_${timestamp}`;
      const customName = designer.name + ' Design';

      // Get size from selector (stored as property, not variant)
      const sizeText = sizeSelect ? sizeSelect.value : 'M';
      
      console.log('=== SIZE DEBUG ===');
      console.log('Size selector value:', sizeText);
      console.log('Size will be stored in Size property');
      console.log('==================');

      const colorMapping = {};
      const swatchColors = getSwatchColors(currentDesigner);
      swatchColors.forEach(color => {
        colorMapping[normalizeColor(color.hex)] = color.name;
      });

      function countLayersByColor(layers) {
        const colorCounts = {};
        
        layers.forEach(layerId => {
          const color = getFill(layerId);
          if (color) {
            const normalizedColor = normalizeColor(color);
            const colorName = colorMapping[normalizedColor] || normalizedColor;
            
            if (!colorCounts[colorName]) {
              colorCounts[colorName] = {
                hex: normalizedColor,
                count: 0,
                layers: []
              };
            }
            colorCounts[colorName].count++;
            colorCounts[colorName].layers.push(layerId);
          }
        });
        
        return colorCounts;
      }

      const bodyLayerCounts = countLayersByColor(bodyLayers);
      const leftSleeveLayerCounts = countLayersByColor(leftSleeveLayers);
      const rightSleeveLayerCounts = countLayersByColor(rightSleeveLayers);
      const hemLayerCounts = countLayersByColor(hemLayers);

      const bodyUsed = Object.keys(bodyLayerCounts);
      const leftSleeveUsed = Object.keys(leftSleeveLayerCounts);
      const rightSleeveUsed = Object.keys(rightSleeveLayerCounts);
      
      const allLayerCounts = {};
      
      function addToTotalCounts(sectionCounts, sectionName) {
        Object.entries(sectionCounts).forEach(([colorName, data]) => {
          if (!allLayerCounts[colorName]) {
            allLayerCounts[colorName] = {
              hex: data.hex,
              bodyStripes: 0,
              leftSleeveStripes: 0,
              rightSleeveStripes: 0,
              hemStripes: 0,
              totalStripes: 0
            };
          }
          
          if (sectionName === 'body') allLayerCounts[colorName].bodyStripes = data.count;
          if (sectionName === 'leftSleeve') allLayerCounts[colorName].leftSleeveStripes = data.count;
          if (sectionName === 'rightSleeve') allLayerCounts[colorName].rightSleeveStripes = data.count;
          if (sectionName === 'hem') allLayerCounts[colorName].hemStripes = data.count;
          
          allLayerCounts[colorName].totalStripes += data.count;
        });
      }
      
      addToTotalCounts(bodyLayerCounts, 'body');
      addToTotalCounts(leftSleeveLayerCounts, 'leftSleeve');
      addToTotalCounts(rightSleeveLayerCounts, 'rightSleeve');
      addToTotalCounts(hemLayerCounts, 'hem');
      
      const productionSummary = Object.entries(allLayerCounts)
        .sort((a, b) => b[1].totalStripes - a[1].totalStripes)
        .map(([colorName, counts]) => {
          return `${colorName}: ${counts.totalStripes} stripes total (Body:${counts.bodyStripes}, L:${counts.leftSleeveStripes}, R:${counts.rightSleeveStripes}, Hem:${counts.hemStripes})`;
        })
        .join('; ');
      
      let publicImageUrl = '';
      let uploadSuccess = false;
      
      try {
        console.log('Uploading design to server...');
        
        const formatColorStripes = (counts) => {
          return Object.entries(counts)
            .map(([name, data]) => `${name} (${data.count} ${data.count === 1 ? 'stripe' : 'stripes'})`)
            .join(', ');
        };
        
        const uploadPayload = {
          imageData: pngDataUrl,
          designId: designId,
          designerName: designer.name,
          properties: {
            size: sizeText,
            bodyColors: `Body (${bodyLayers.length} stripes): ${formatColorStripes(bodyLayerCounts)}`,
            leftSleeveColors: `Left Sleeve (${leftSleeveLayers.length} stripes): ${formatColorStripes(leftSleeveLayerCounts)}`,
            rightSleeveColors: `Right Sleeve (${rightSleeveLayers.length} stripes): ${formatColorStripes(rightSleeveLayerCounts)}`,
            hemColors: `Hem (${hemLayers.length} stripes): ${formatColorStripes(hemLayerCounts)}`,
            productionSummary: productionSummary,
            totalStripes: Object.values(allLayerCounts).reduce((sum, c) => sum + c.totalStripes, 0),
            uniqueColors: Object.keys(allLayerCounts).length,
            timestamp: new Date().toISOString()
          }
        };
        
        const uploadResponse = await fetch('https://uploads.pabon.shop/upload.php', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(uploadPayload)
        });
        
        const uploadResult = await uploadResponse.json();
        console.log('Upload response:', uploadResult);
        
        if (uploadResult.success) {
          publicImageUrl = uploadResult.url;
          uploadSuccess = true;
          console.log('Design uploaded successfully. URL:', publicImageUrl);
        } else {
          console.error('Upload failed:', uploadResult.message);
        }
      } catch (uploadError) {
        console.error('Upload error:', uploadError);
      }
      
      const properties = { 
        "_Custom_Name": customName,
        "_Designer": designer.name,
        "_Design_ID": designId,
        "_Design_Date": new Date().toISOString().split('T')[0],
        "Size": sizeText,
        "_Design_PNG": pngDataUrl
      };
      
      if (uploadSuccess && publicImageUrl) {
        properties["_Design_Image_URL"] = publicImageUrl;
        properties["_Design_Status"] = "Uploaded Successfully";
      } else {
        properties["_Design_Status"] = "Upload Pending - Check Server";
        properties["_Design_Image_URL"] = "";
      }
      
      properties["_Body_Colors"] = bodyLayers.length > 0 ? 
        `Body (${bodyLayers.length} stripes): ${
          Object.entries(bodyLayerCounts)
            .map(([name, data]) => `${name} (${data.count} ${data.count === 1 ? 'stripe' : 'stripes'})`)
            .join(', ')
        }` : 'Body: No stripes';
      
      properties["_Left_Sleeve_Colors"] = leftSleeveLayers.length > 0 ?
        `Left Sleeve (${leftSleeveLayers.length} stripes): ${
          Object.entries(leftSleeveLayerCounts)
            .map(([name, data]) => `${name} (${data.count} ${data.count === 1 ? 'stripe' : 'stripes'})`)
            .join(', ')
        }` : 'Left Sleeve: No stripes';
      
      properties["_Right_Sleeve_Colors"] = rightSleeveLayers.length > 0 ?
        `Right Sleeve (${rightSleeveLayers.length} stripes): ${
          Object.entries(rightSleeveLayerCounts)
            .map(([name, data]) => `${name} (${data.count} ${data.count === 1 ? 'stripe' : 'stripes'})`)
            .join(', ')
        }` : 'Right Sleeve: No stripes';
      
      properties["_Hem_Colors"] = hemLayers.length > 0 ?
        `Hem/Cuffs (${hemLayers.length} stripes): ${
          Object.entries(hemLayerCounts)
            .map(([name, data]) => `${name} (${data.count} ${data.count === 1 ? 'stripe' : 'stripes'})`)
            .join(', ')
        }` : 'Hem/Cuffs: No stripes';
      
      properties["_Production_Summary"] = productionSummary;
      properties["_Total_Stripes"] = `${Object.values(allLayerCounts).reduce((sum, c) => sum + c.totalStripes, 0)} stripes across all sections`;
      properties["_Unique_Colors"] = `${Object.keys(allLayerCounts).length} unique colors`;
      
      const totalStripes = Object.values(allLayerCounts).reduce((sum, c) => sum + c.totalStripes, 0);
      const estimatedWeight = (totalStripes * 100) / 1000;
      properties["_Material_Estimate"] = `Approximately ${estimatedWeight.toFixed(2)} kg total wool needed`;

      console.log('Adding to cart with properties:', properties);
      console.log('Using single variant ID:', chosenVariant);
      
      const addResp = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          id: chosenVariant, 
          quantity: 1, 
          properties: properties 
        })
      });

      if(!addResp.ok) {
        const err = await addResp.json().catch(()=>({ message: 'Add to cart failed' }));
        throw new Error(err?.description || err?.message || 'Add failed');
      }

      const cartItem = await addResp.json();
      console.log('Successfully added to cart:', cartItem);

      if (uploadSuccess && publicImageUrl) {
        try {
          await fetch('https://uploads.pabon.shop/notify_order.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              design_id: designId,
              design_url: publicImageUrl,
              designer: designer.name,
              size: sizeText,
              properties: properties,
              production_data: allLayerCounts,
              cart_token: cartItem.key || '',
              timestamp: new Date().toISOString()
            })
          });
          console.log('Server notified of pending order with production data');
          console.log('Size sent to factory:', sizeText);
        } catch (notifyError) {
          console.warn('Notification failed (non-critical):', notifyError);
        }
      }

      showConfirmation();

      console.log('Design successfully added to cart. Customer can download from order details.');

    } catch(err) {
      console.error('Add-to-cart error', err);
      alert('Error adding to cart: ' + (err.message || err));
    } finally {
      addBtn.dataset.busy = '0';
      addBtn.style.opacity = '1';
      addBtn.textContent = origText;
    }
  });

  makeShapesClickable();
  buildSwatches();
  applyDefaults();
  refreshConstraints();
  updateAddToCartButton();
  updateMiniThumbnail(0);
  syncMobileButtons();

  // Color picker tooltip functionality
  const colorPickerTooltip = document.getElementById('color-picker-tooltip');
  let tooltipDismissed = false;

  function showColorPickerTooltip() {
    if (!tooltipDismissed && colorPickerTooltip) {
      colorPickerTooltip.style.display = 'block';
    }
  }

  function hideColorPickerTooltip() {
    if (colorPickerTooltip) {
      colorPickerTooltip.style.display = 'none';
      tooltipDismissed = true;
    }
  }

  setTimeout(showColorPickerTooltip, 500);

  if (colorPickerTooltip) {
    colorPickerTooltip.addEventListener('mouseenter', hideColorPickerTooltip);
  }

  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('color-swatch')) {
      hideColorPickerTooltip();
    }
  });

  // ========== TUTORIAL ANIMATION ==========
  const tutorialBtn = document.getElementById('tutorial-btn');
  const tutorialCursor = document.getElementById('tutorial-cursor');
  let tutorialPlaying = false;

  if (tutorialBtn && tutorialCursor) {
    tutorialBtn.addEventListener('click', playTutorial);
  }

  async function playTutorial() {
    if (tutorialPlaying) return;
    tutorialPlaying = true;
    tutorialBtn.classList.add('playing');
    tutorialBtn.textContent = '⏸';
    
    // Get elements - find the actual shape elements that have click handlers
    const allSwatches = swatchContainer.querySelectorAll('.color-swatch');
    const firstSwatch = allSwatches[0];
    const secondSwatch = allSwatches[1];
    
    // Find stripe elements from their parent groups
    const firstStripeGroup = document.getElementById('Laag_3');
    const firstStripe = firstStripeGroup ? firstStripeGroup.querySelector('path, rect, polygon, polyline, circle, ellipse') : null;
    
    const secondStripeGroup = document.getElementById('Laag_5');
    const secondStripe = secondStripeGroup ? secondStripeGroup.querySelector('path, rect, polygon, polyline, circle, ellipse') : null;
    
    if (!firstSwatch || !firstStripe) {
      tutorialPlaying = false;
      tutorialBtn.classList.remove('playing');
      tutorialBtn.textContent = '?';
      return;
    }
    
    // Helper function to move cursor
    function moveCursor(element, duration = 800) {
      return new Promise(resolve => {
        const rect = element.getBoundingClientRect();
        const x = rect.left + rect.width / 2;
        const y = rect.top + rect.height / 2;
        
        tutorialCursor.style.transition = `all ${duration}ms cubic-bezier(0.4, 0, 0.2, 1)`;
        tutorialCursor.style.left = x + 'px';
        tutorialCursor.style.top = y + 'px';
        
        setTimeout(resolve, duration);
      });
    }
    
    // Helper function to click animation
    function simulateClick() {
      return new Promise(resolve => {
        tutorialCursor.classList.add('clicking');
        setTimeout(() => {
          tutorialCursor.classList.remove('clicking');
          resolve();
        }, 300);
      });
    }
    
    // Helper to actually change stripe color
    function changeStripeColor(stripe, color) {
      if (stripe && color) {
        stripe.style.fill = normalizeColor(color);
      }
    }
    
    // Start animation - position cursor off screen
    tutorialCursor.classList.add('active');
    tutorialCursor.style.transition = 'none';
    tutorialCursor.style.left = '-100px';
    tutorialCursor.style.top = '-100px';
    tutorialCursor.style.opacity = '1';
    
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // FIRST INTERACTION
    // Step 1: Move to first swatch
    firstSwatch.classList.add('tutorial-highlight');
    await moveCursor(firstSwatch, 1000);
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // Step 2: Click swatch and select color
    await simulateClick();
    firstSwatch.classList.remove('tutorial-highlight');
    firstSwatch.click(); // Select the swatch
    const firstColor = firstSwatch.style.backgroundColor || getComputedStyle(firstSwatch).backgroundColor;
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Step 3: Move to first stripe
    firstStripe.classList.add('tutorial-highlight');
    await moveCursor(firstStripe, 1000);
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // Step 4: Click stripe and apply color
    await simulateClick();
    firstStripe.classList.remove('tutorial-highlight');
    changeStripeColor(firstStripe, activeColor); // Use the active color
    refreshConstraints();
    await new Promise(resolve => setTimeout(resolve, 800));
    
    // SECOND INTERACTION
    if (secondSwatch && secondStripe) {
      // Move to second swatch
      secondSwatch.classList.add('tutorial-highlight');
      await moveCursor(secondSwatch, 800);
      await new Promise(resolve => setTimeout(resolve, 200));
      
      // Click second swatch
      await simulateClick();
      secondSwatch.classList.remove('tutorial-highlight');
      secondSwatch.click();
      await new Promise(resolve => setTimeout(resolve, 400));
      
      // Move to second stripe
      secondStripe.classList.add('tutorial-highlight');
      await moveCursor(secondStripe, 800);
      await new Promise(resolve => setTimeout(resolve, 200));
      
      // Click second stripe and apply color
      await simulateClick();
      secondStripe.classList.remove('tutorial-highlight');
      changeStripeColor(secondStripe, activeColor);
      refreshConstraints();
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // End animation - fade out and hide cursor
    tutorialCursor.style.transition = 'opacity 0.3s ease';
    tutorialCursor.style.opacity = '0';
    
    await new Promise(resolve => setTimeout(resolve, 300));
    
    tutorialCursor.classList.remove('active');
    tutorialCursor.style.left = '-100px';
    tutorialCursor.style.top = '-100px';
    
    tutorialPlaying = false;
    tutorialBtn.classList.remove('playing');
    tutorialBtn.textContent = '?';
  }
  // ========== END TUTORIAL ANIMATION ==========
}
</script>